########################################################
# Este script coge los directorios de nuevos APTs, Crea los subdirectorios peframe y reports, obtiene su MD5
#y obtiene los anÃ¡lisis dinamico (mediante curl.sh) y estattico (mediante peframe)
##########################################

#!/bin/bash

#ESTADO:
# - Todos los peframe obtenidos
# - Todos los reports obtenidos

for i in 0 1 2 3 4 5 6 7 8 9 a b c d e f 
do
	mkdir $i/peframe
	mkdir $i/reports
	mkdir $i/tested
	APIKEY=XXXXXXXXXXXX
	for j in `ls -l $i | grep "^-" | awk '{ print $9 }'`
	do
		md5=`md5sum $i/$j | awk '{ print $1 }'`

		#Obtain analisis from virustotal
		./00_curl.sh $md5 $APIKEY | sed 's/: null/: \"null\"/g' > $i/reports/$md5.report

		grep "QuotaExceeded" $i/reports/$md5.report > /dev/null
		if [ $? -eq 0 ]
		then
		   APIKEY=$[$APIKEY +1]
		fi

		#mv to tested (if not arrived to full Quota)
		mv $i/$j $i/tested

		#Static analysis with peframe
		peframe $i/$j > $i/peframe/$md5.peframe

	done
done
