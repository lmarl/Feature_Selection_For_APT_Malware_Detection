import numpy as np
from numpy import *
import pandas as pd
from time import time
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.ticker import NullFormatter
from pandas.plotting import scatter_matrix
from sklearn import manifold



###LEEMOS EL DATASET
input_file= "../datasets/csv_a_empezar_desde_cero_v2_sin_cols21y37_con52_y_49_46_y43_40_34_31_28_24_17_14_10_final_con_cabecera_quitamos_5_muestras_develgroup_country_new_headers.csv"

df = pd.read_csv(input_file, header = 0, sep=';', dtype={"MD5":object,"FIRST_SEEN":object,"SIZE":int,"NUM_PACKERS":float64,"PACKERS_BIN":float64,"PACKERS_BIN_DIST":float64,"MALWARE_TYPE":object,"NUM_IMPORTS":
float64,"IMPORTS_BIN":float64,"IMPORTS_BINARY_DIST":float64,"HAS_OVERLAYS":int,"SUSPICIOUS_DLLS":float64,"SUSPICIOUS_DLLS_DIST":float64,"ANTIDEBUG_BINARY":float64,"ANTIDEBUG_BINARY_DIST":float64,"NUM_LANG":fl
oat64,"LANG_BINARY":float64,"LANG_BINARY_DIST":float64,"API_BINARY":float64,"API_BINARY_DIST":float64,"RESOURCE_NUM":int,"SERVICES_BINARY":float64,"SERVICES_BINARY_DIST":float64,"all_files_binary":float64,"al
l_files_binary_DIST":float64,"all_opened_files_binary":float64,"all_opened_files_binary_DIST":float64,"all_written_files_binary":float64,"all_written_files_binary_DIST":float64,"all_deleted_files_binary":floa
t64,"all_deleted_files_binary_DIST":float64,"all_read_files_binary":float64,"all_read_files_binary_DIST":float64,"UDP_Countries":float64,"UDP_Countries_DIST":float64,"TCP_countries":float64,"TCP_countries_DIS
T":float64,"DNS_countries":float64,"DNS_countries_DIST":float64,"SSDEEP":int,"IMPHASH":int,"APT":int,"NUM_APT":int})


###EXTRAEMOS LAS MUESTRAS DE LA APT APT1
df_APT1=df.loc[df['NUM_APT'] == 12]

###EXTRAEMOS LOS CAMPOS OBJETIVO Y QUE NO NOS INTERESAN
malwaretypes=df.MALWARE_TYPE
ssdeeptypes=df.SSDEEP
imphashtypes=df.IMPHASH
apttypes=df.APT
numapt=df.NUM_APT

###Y NOS QUEDAMOS CON SUS VALORES
values=malwaretypes.values.astype(np.int64)
values2=apttypes.values.astype(np.int64)
values3=numapt.values.astype(np.int64)

###PARA FINALMENTE BORRARLOS DEL DATASET
del df['MALWARE_TYPE']
del df['APT']
del df['MD5']
del df['FIRST_SEEN']
del df['SSDEEP']
del df['IMPHASH']
del df['NUM_APT']

###Y TAMBIEN DEL LISTADO DE APT1
del df_APT1['MALWARE_TYPE']
del df_APT1['APT']
del df_APT1['MD5']
del df_APT1['FIRST_SEEN']
del df_APT1['SSDEEP']
del df_APT1['IMPHASH']
del df_APT1['NUM_APT']

####Borramos los DIST
del df['PACKERS_BIN_DIST']
del df['IMPORTS_BINARY_DIST']
del df['ANTIDEBUG_BINARY_DIST']
del df['LANG_BINARY_DIST']
del df['API_BINARY_DIST']
del df['SERVICES_BINARY_DIST']
del df['SUSPICIOUS_DLLS_DIST']
del df['all_files_binary_DIST']
del df['all_written_files_binary_DIST']
del df['all_deleted_files_binary_DIST']
del df['all_read_files_binary_DIST']
del df['all_opened_files_binary_DIST']
del df['UDP_Countries_DIST']
del df['DNS_countries_DIST']
del df['TCP_countries_DIST']

del df_APT1['PACKERS_BIN_DIST']
del df_APT1['IMPORTS_BINARY_DIST']
del df_APT1['ANTIDEBUG_BINARY_DIST']
del df_APT1['LANG_BINARY_DIST']
del df_APT1['API_BINARY_DIST']
del df_APT1['SERVICES_BINARY_DIST']
del df_APT1['SUSPICIOUS_DLLS_DIST']
del df_APT1['all_files_binary_DIST']
del df_APT1['all_written_files_binary_DIST']
del df_APT1['all_deleted_files_binary_DIST']
del df_APT1['all_read_files_binary_DIST']
del df_APT1['all_opened_files_binary_DIST']
del df_APT1['UDP_Countries_DIST']
del df_APT1['DNS_countries_DIST']
del df_APT1['TCP_countries_DIST']

#
#NOS QUEDAMOS CON LAS 240 FEATURES QUE SE HAN SELECCIONADO EN EL APARTADO ANTERIOR. Si queremos dejarlo como estaba solo hay que quitar las siguientes lineas
#
df1=df[['ALL_FILES_//.','ALL_FILES_C:','ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data','ALL_FILES_C:/Program_Files/Windows_NT/Accessories','ALL_FILES_C:/WINDOWS/system32','ANTIDEBUG_FindWindowExW','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32FirstW','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DNS_PL','DNS_US','IMPORTS_BIN_AdjustTokenPrivileges','IMPORTS_BIN_ByHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_CreateRemoteThread','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_FindClose','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_FindResource','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCompressed','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetCurrentProcessId','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetLongPathName','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_inet_addr','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_InternetOpen','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadResource','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_MoveFile','IMPORTS_BIN_OpenFile','IMPORTS_BIN_RaiseException','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_ReplaceFile','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SetForegroundWindow','IMPORTS_BIN_SetWindowPos','IMPORTS_BIN_UnhandledExceptionFilter','IMPORTS_BIN_VirtualAlloc','IMPORTS_BIN_VirtualProtect','IMPORTS_BIN_WideCharToMultiByte','IMPORTS_BIN_wsprintfA','OPENED_FILES_//.','OPENED_FILES_C:','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/Documents_and_Settings/<USER>','OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup','OPENED_FILES_C:/Program_Files/Internet_Explorer','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_C:/WINDOWS/Tasks','OPENED_FILES_//./PIPE','PACKER_Armadillo','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','READ_FILES_C:/Program_Files/Windows_NT/Accessories','READ_FILES_C:/WINDOWS/system32/wbem','SERVICES_Ias','SERVICES_MpsSvc','SERVICES_nm','SUSP_API_connect','SUSP_API_CopyFileA','SUSP_API_CopyFileW','SUSP_API_CreateDirectoryA','SUSP_API_CreateFileA','SUSP_API_CreateFileMappingW','SUSP_API_CreateProcessA','SUSP_API_CreateProcessAsUserA','SUSP_API_CreateServiceW','SUSP_API_CreateThread','SUSP_API_CryptEncrypt','SUSP_API_DeleteFileA','SUSP_API_DeleteFileW','SUSP_API_DisconnectNamedPipe','SUSP_API_ExitThread','SUSP_API_FindNextFileA','SUSP_API_FindResourceA','SUSP_API_FindResourceW','SUSP_API_FindWindowExA','SUSP_API_GetComputerNameA','SUSP_API_GetCurrentProcess','SUSP_API_GetCurrentProcessId','SUSP_API_GetDriveTypeW','SUSP_API_GetModuleHandleA','SUSP_API_GetModuleHandleW','SUSP_API_GetStartupInfoW','SUSP_API_GetTempPathA','SUSP_API_GetTempPathW','SUSP_API_HttpSendRequestExA','SUSP_API_HttpSendRequestExW','SUSP_API_InternetOpenA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_Process32FirstW','SUSP_API_RegCloseKey','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyExW','SUSP_API_RegCreateKeyW','SUSP_API_RegDeleteKeyA','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExW','SUSP_API_RegOpenKeyA','SUSP_API_ShellExecuteA','SUSP_API_ShellExecuteExA','SUSP_API_Sleep','SUSP_API_StartServiceA','SUSP_API_StartServiceCtrlDispatcherW','SUSP_API_TerminateProcess','SUSP_API_UnhandledExceptionFilter','SUSP_API_VirtualAlloc','SUSP_API_VirtualFree','SUSP_API_VirtualFreeEx','SUSP_API_VirtualProtect','SUSP_API_WriteFile','SUSP_API_WriteProcessMemory','SUSP_API_WSASocketA','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_crypt32.dll','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_Iphlpapi.dll','SUSP_DLLS_MFC42.DLL','SUSP_DLLS_MSI.dll','SUSP_DLLS_MSIMG32.dll','SUSP_DLLS_MSVCP60.dll','SUSP_DLLS_NETAPI32.dll','SUSP_DLLS_ntdll.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_OPENGL32.DLL','SUSP_DLLS_wininet.dll','SUSP_DLLS_ws2_32.dll','SUSP_DLLS_WSOCK32.DLL','SUSP_DLLS_WTSAPI32.dll','TCP_GB','TCP_IE','TCP_US','UDP_FR','UDP_IE','UDP_US','ALL_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','ALL_FILES_C:/WINDOWS/Registration','ANTIDEBUG_FindWindowExA','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','HAS_OVERLAYS','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_Connect','IMPORTS_BIN_CreateFileA','IMPORTS_BIN_CreateThread','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DeleteFileA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindFirstFileA','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_GetCommandLineA','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetModuleFileNameA','IMPORTS_BIN_GetModuleHandleA','IMPORTS_BIN_GetProcAddress','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStartupInfoA','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GetTickCount','IMPORTS_BIN_GetVersionExA','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_HeapFree','IMPORTS_BIN_LoadLibraryA','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_ReadFile','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_ShellExecuteA','IMPORTS_BIN_Sleep','IMPORTS_BIN_TerminateProcess','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_VirtualFree','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WriteFile','MALWARE_TYPE','NUM_IMPORTS','NUM_LANG','NUM_PACKERS','READ_FILES_C:/WINDOWS/Registration','RESOURCE_NUM','SUSP_API_CreateFileW','SUSP_API_FindFirstFileA','SUSP_API_GetCommandLineA','SUSP_API_GetFileAttributesA','SUSP_API_GetModuleFileNameA','SUSP_API_GetStartupInfoA','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_GetVersionExA','SUSP_API_LoadLibraryA','SUSP_API_LockResource','SUSP_API_RegOpenKeyExA','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll']]

df=df1

###SACAMOS LOS NOMBRES DE LOS CAMPOS
atributos=list(df)
###...Y SUS VALORES
df3=df.values

###ESTANDARIZAMOS
from sklearn import preprocessing
df2 = preprocessing.scale(df)
df = pd.DataFrame(df2)

###CALCULAMOS LAS CORRELACIONES ENTRE LOS CAMPOS DEL DATASET
correlations=df.corr()

###SACAMOS EL HISTOGRAMA DE TODOS LOS CAMPOS
####df.hist(figsize=[22,16],layout=[5,8])

###CREAMOS UNA FIGURA
fig = plt.figure(figsize=(16,16))

###Y VAMOS RECORRIENDO TODOS LOS CAMPOS (6x6)...
numfield=1
for i in range (0,4):
	for j in range(0,5):
		ax = fig.add_subplot(5,4,numfield)
		###...pintando el histograma de cada campo
		plt.hist(df.values[:,numfield-1])

		###...y el histograma de la APT APT1
		plt.hist(df_APT1.values[:,numfield-1])
		plt.title(atributos[numfield-1])
		numfield=numfield+1

plt.subplots_adjust(hspace=0.7, wspace=0.4)
fig.savefig('resultados/comparativa_histogramas_240.png')
plt.show()
