import numpy as np
from numpy import *
import pandas as pd
from time import time
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.ticker import NullFormatter
from sklearn import manifold
from sklearn.manifold import TSNE
from sklearn.externals import joblib
import sys
import time
import warnings
warnings.simplefilter(action='ignore', category=FutureWarning)

from sklearn import svm
from sklearn.model_selection import cross_val_predict
from sklearn.model_selection import cross_val_score

from sklearn.metrics import confusion_matrix
from sklearn.metrics import precision_score, recall_score

from sklearn.impute import SimpleImputer
from sklearn import preprocessing

start = time.time()
##################################
# PREPARATIVOS
##################################

########
###Leemos el dataset
#input_file = "../datasets/csv_a_empezar_desde_cero_v2_sin_cols21y37_con52_y_49_46_y43_40_34_31_28_24_17_14_10_final_con_cabecera_quitamos_5_muestras_develgroup_country_new_headers.csv"
#input_file = "../datasets/dataset_1941_features_and_19457_rows.csv"
input_file = "../datasets/reducido_a_1941_features_without_NaNs_y_19457_rows.csv"
input_file2 = "../datasets/newDatasetFinal5.csv"

df = pd.read_csv(input_file, header = 0, sep=";")

total_muestras=df.shape[0]
print (total_muestras)

########
###Separamos los campos que no nos interesan y campos objetivo
isapt=df.APT
numapt=df.NUM_APT
#md5=df.MD5

###Quitamos las cabeceras de los campos objetivo
#values=malwaretypes.values.astype(np.int64)
values2=isapt.values.astype(np.int64)
values3=numapt.values.astype(np.int64)


df1=df[['ANTIDEBUG_FindWindowA','ANTIDEBUG_FindWindowExA','ANTIDEBUG_FindWindowExW','ANTIDEBUG_GetWindowThreadProcessId','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32First','ANTIDEBUG_Process32Next','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DNS_CN','DNS_NL','DNS_US','HAS_OVERLAYS','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateFile','IMPORTS_BIN_CreateFileMapping','IMPORTS_BIN_CreateMutex','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_CreateWindowExA','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_DispatchMessageA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindClose','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_FindResource','IMPORTS_BIN_FindWindow','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetCurrentProcessId','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetDlgItem','IMPORTS_BIN_GetFileAttributes','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetFileType','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalAlloc','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_HeapFree','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_InternetOpen','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_IsWindow','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadLibrary','IMPORTS_BIN_LoadResource','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_MessageBoxA','IMPORTS_BIN_MoveFile','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_OpenFile','IMPORTS_BIN_PostQuitMessage','IMPORTS_BIN_RaiseException','IMPORTS_BIN_ReadFile','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RegCreateKey','IMPORTS_BIN_RegOpenKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_RegSetValue','IMPORTS_BIN_RegSetValueExA','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_ShowWindow','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_TlsSetValue','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WideCharToMultiByte','IMPORTS_BIN_wsprintfA','isOtherType','isRootkit','isSpyware','isTrojan','isTypeUnknown','isWorm','NUM_IMPORTS','NUM_PACKERS','OPENED_FILES_//.','OPENED_FILES_C:','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/Program_Files','OPENED_FILES_C:/Program_Files/Internet_Explorer','OPENED_FILES_C:/WINDOWS','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_C:/WINDOWS/system32/drivers','OPENED_FILES_//./PIPE','PACKER_Armadillo','PACKER_BobSoft','PACKER_MSLRH','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','READ_FILES_C:/Program_Files/Internet_Explorer','READ_FILES_C:/WINDOWS/Registration','READ_FILES_C:/WINDOWS/system32','RESOURCE_NUM','SERVICES_AudioSrv','SERVICES_RASMAN','SERVICES_RemoteAccess','SERVICES_Router','SUSP_API_ConnectNamedPipe','SUSP_API_CopyFileA','SUSP_API_CreateDirectoryW','SUSP_API_CreateFileA','SUSP_API_CreateFileMappingA','SUSP_API_CreateFileW','SUSP_API_CreateProcessW','SUSP_API_CreateServiceA','SUSP_API_CreateThread','SUSP_API_CreateToolhelp32Snapshot','SUSP_API_DeleteFileA','SUSP_API_DeleteFileW','SUSP_API_ExitThread','SUSP_API_FindFirstFileA','SUSP_API_FindFirstFileW','SUSP_API_FindNextFileA','SUSP_API_FindNextFileW','SUSP_API_FindResourceA','SUSP_API_FindResourceW','SUSP_API_FindWindowA','SUSP_API_FindWindowExW','SUSP_API_GetCommandLineA','SUSP_API_GetCommandLineW','SUSP_API_GetComputerNameA','SUSP_API_GetDriveTypeA','SUSP_API_GetFileAttributesExA','SUSP_API_GetFileAttributesW','SUSP_API_GetFileSize','SUSP_API_GetModuleFileNameA','SUSP_API_GetModuleFileNameW','SUSP_API_GetModuleHandleA','SUSP_API_GetModuleHandleW','SUSP_API_GetProcAddress','SUSP_API_GetStartupInfoA','SUSP_API_GetStartupInfoW','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_GetUserNameA','SUSP_API_GetVersionExA','SUSP_API_GetVersionExW','SUSP_API_GetWindowThreadProcessId','SUSP_API_HttpQueryInfoA','SUSP_API_HttpSendRequestA','SUSP_API_InternetCloseHandle','SUSP_API_InternetConnectA','SUSP_API_InternetOpenA','SUSP_API_InternetReadFile','SUSP_API_LoadLibraryA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_LockResource','SUSP_API_OpenProcess','SUSP_API_OpenProcessToken','SUSP_API_OutputDebugStringA','SUSP_API_Process32First','SUSP_API_Process32Next','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyExW','SUSP_API_RegDeleteKeyA','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExA','SUSP_API_RegOpenKeyA','SUSP_API_RegOpenKeyExA','SUSP_API_RegOpenKeyExW','SUSP_API_SetWindowsHookExA','SUSP_API_ShellExecuteA','SUSP_API_ShellExecuteExA','SUSP_API_Sleep','SUSP_API_StartServiceA','SUSP_API_VirtualAlloc','SUSP_API_VirtualAllocEx','SUSP_API_VirtualFree','SUSP_API_VirtualProtect','SUSP_API_WinExec','SUSP_API_WriteFile','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_DLL_EN_BLANCO','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_KERNEL32','SUSP_DLLS_KERNEL32.dll','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_URLMON.DLL','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll','SUSP_DLLS_wininet.dll','SUSP_DLLS_WINMM.DLL','SUSP_DLLS_WINSPOOL.DRV','SUSP_DLLS_ws2_32.dll','SUSP_DLLS_WSOCK32.DLL','TCP_US','UDP_NL','UDP_US']]


#df1=df[['ALL_FILES_C:','ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft','ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB','ALL_FILES_C:/Program_Files/Windows_NT/Accessories','ANTIDEBUG_CheckRemoteDebuggerPresent','ANTIDEBUG_FindWindowExA','ANTIDEBUG_FindWindowExW','ANTIDEBUG_GetWindowThreadProcessId','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32NextW','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data','DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs','DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop','DELETED_FILES_c:/windows/temp','DNS_CH','DNS_CZ','DNS_IL','DNS_NL','DNS_SY','IMPORTS_BIN_bind','IMPORTS_BIN_CallNextHookEx','IMPORTS_BIN_CharNextA','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateMutex','IMPORTS_BIN_CreateSymbolicLink','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DispatchMessageA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_FindWindow','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetClientRect','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetDlgItem','IMPORTS_BIN_GetFileInformation','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetFileType','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetLongPathName','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GetWindowLongA','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalAlloc','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_HeapFree','IMPORTS_BIN_inet_addr','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadLibrary','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_OpenFile','IMPORTS_BIN_RegOpenKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_RegSetValueExA','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetWindowLongA','IMPORTS_BIN_ShowWindow','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_wsprintfA','OPENED_FILES_C:','OPENED_FILES_C:/Documents_and_Settings/<USER>','OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_c:/windows/temp','OPENED_FILES_//./Global','PACKER_Armadillo','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch','SERVICES_AudioSrv','SERVICES_Ias','SERVICES_NetDDEdsdm','SERVICES_Ntmssvc','SERVICES_RASMAN','SERVICES_Win32','SERVICES_WmiApSrv','SUSP_API_CopyFileA','SUSP_API_CopyFileW','SUSP_API_CreateFileA','SUSP_API_CreateProcessAsUserA','SUSP_API_CreateProcessW','SUSP_API_CreateProcessWithLogonW','SUSP_API_CreateServiceW','SUSP_API_CreateThread','SUSP_API_CryptEncrypt','SUSP_API_DeleteFileA','SUSP_API_DisconnectNamedPipe','SUSP_API_FindFirstFileA','SUSP_API_FindFirstFileExW','SUSP_API_GetCommandLineW','SUSP_API_GetModuleFileNameA','SUSP_API_GetProcAddress','SUSP_API_GetStartupInfoA','SUSP_API_GetStartupInfoW','SUSP_API_GetTempPathW','SUSP_API_GetVersionExA','SUSP_API_HttpSendRequestExA','SUSP_API_HttpSendRequestExW','SUSP_API_InternetConnectA','SUSP_API_InternetOpenA','SUSP_API_InternetOpenUrlA','SUSP_API_InternetQueryOptionA','SUSP_API_LoadLibraryA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_LockResource','SUSP_API_OpenFileMappingW','SUSP_API_OpenProcess','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyW','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExA','SUSP_API_RegOpenKeyExA','SUSP_API_ShellExecuteExA','SUSP_API_SleepEx','SUSP_API_StartServiceA','SUSP_API_StartServiceCtrlDispatcherW','SUSP_API_StartServiceW','SUSP_API_VirtualFree','SUSP_API_WriteFile','SUSP_API_WriteProcessMemory','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_crypt32.dll','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_KERNEL32.dll','SUSP_DLLS_MFC42.DLL','SUSP_DLLS_MSVFW32.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OPENGL32.DLL','SUSP_DLLS_SECUR32.dll','SUSP_DLLS_wininet.dll','SUSP_DLLS_WSOCK32.DLL','TCP_AE','TCP_CH','TCP_CN','TCP_DE','TCP_KR','TCP_MD','TCP_NL','TCP_US','UDP_CL','UDP_GB','UDP_MD','UDP_MT','UDP_US','ALL_FILES_C:/WINDOWS/system32','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','DNS_US','HAS_OVERLAYS','IMPORTS_BIN_CreateFile','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetFileAttributes','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MoveFile','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_ReadFile','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WideCharToMultiByte','NUM_IMPORTS','NUM_LANG','NUM_PACKERS','OPENED_FILES_//.','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/WINDOWS','OPENED_FILES_//./PIPE','READ_FILES_C:/WINDOWS/Registration','READ_FILES_C:/WINDOWS/system32','RESOURCE_NUM','SUSP_API_CreateFileW','SUSP_API_FindNextFileA','SUSP_API_FindResourceA','SUSP_API_GetCommandLineA','SUSP_API_GetFileSize','SUSP_API_GetModuleHandleA','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_RegDeleteKeyA','SUSP_API_ShellExecuteA','SUSP_API_Sleep','SUSP_API_VirtualAlloc','SUSP_API_VirtualProtect','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll','isOtherType','isTrojan','isWorm','isBackdoor','isRootkit','isSpyware']]

df=df1

##################################
# RELLENAMOS VALORES VACIOS
##################################
imp = SimpleImputer(strategy="most_frequent")
X=imp.fit_transform(df)

##################################
# Standarization
##################################
#df = preprocessing.scale(df)
X = preprocessing.scale(X)

##################################
# Preparando Training y Testing sets
##################################
#
#Barajamos las muestras. Realmente lo que se barajan son los indices.
shuffle_index=np.random.permutation(17000)

#Nos quedamos con los valores, descartando las cabeceras
df3=X
df=X

###########
#X_train son las 17000 primeras muestras. X_test son las 3547 ultimas muestras
#Y_train es un 0 o un 1 por cada una de esas 17000 muestras indicando si se trata de un APT o no
#Y_test es un 0 o un 1 por cada una de esas 3547 muestras indicando si se trata de un APT o no
X_train,X_test,Y_train,Y_test=df[:17000],df[17000:],isapt[:17000],isapt[17000:]

###########################################
# TARGET VECTORS
###########################################

#Pasamos de valores 0 o 1 a valores true or false:
Y_train_APT=(Y_train == 1)
Y_test_APT=(Y_test == 1)


print ("################################################")
print ("            SVC")
print ("################################################")

###########################################
# SVC
###########################################

#for i in range(40):
#    for j in range (X_test.shape[0]/40):
#        print (X_test[(40*i)+j])
#    print ("-")

print (Y_test_APT)


    #Creamos el clasificador. El random_state value no deberia afectar
svm_clf = svm.SVC(C=0.3, probability=True)

    #Y lo entrenamos con el training Set
svm_clf.fit(X_train, Y_train_APT)

    #Predecimos valores
y_test_pred=cross_val_predict(svm_clf, X_test, Y_test_APT)
array_scores=cross_val_score(svm_clf, X_test, Y_test_APT, cv=10, scoring="accuracy")*100
#print("Hacemos la prediccion con la funcion de sklearn predict 10 foldings: " % array_scores.mean())

###########
# Confusion Matrix
###########

print "\nConfusion Matrix"
print confusion_matrix(Y_test_APT,y_test_pred)

print "\nPreciosion Score:"
print precision_score(Y_test_APT,y_test_pred)

print "\nRecall Score:"
print recall_score(Y_test_APT,y_test_pred)

##########
# ROC Curve
#
# Esta grafica nos permite decidir cual de los clasificadores son mejores
###########
from sklearn.metrics import roc_curve, auc

fig = plt.figure(figsize=(15, 15))
#
#######SVC########
y_probabilities_svm=cross_val_predict(svm_clf, X_test, Y_test_APT, cv=5,method="predict_proba")
y_scores_svm=y_probabilities_svm[:,1]
fpr_svm, tpr_svm, threshold_svm=roc_curve(Y_test_APT,y_scores_svm)
roc_auc = auc(fpr_svm, tpr_svm)
plt.plot(fpr_svm, tpr_svm, linewidth=2, label='Roc Curve de SVM (area= %0.4f)' % roc_auc)

######PAINT IT!!!########
#fig.tight_layout()
#plt.plot([0,1],[0,1],"k--")
#plt.axis([0,1,0,1])
#plt.xlabel("False Positive rate")
#plt.ylabel("True Positive rate")
#plt.legend()
#plt.show()
#plt.savefig('resultados/Roc_Curve_With_Original_data.png', bbox_inches='tight')



print("==================================")
print("COMENZAMOS A USAR LOS NUEVOS DATOS")
print("==================================")

df = pd.read_csv(input_file2, header = 0)

total_muestras=df.shape[0]

##################################
# BARAJAMOS ORDEN
##################################
#Barajamos las muestras. Realmente lo que se barajan son los indices.

df = df.sample(frac=1).reset_index(drop=True)

###Separamos los campos que no nos interesan y campos objetivo
isapt=df.isAPT
numapt=df.NUMAPT
md5=df.MD5

########
###Quitamos las cabeceras de los campos objetivo
#values=malwaretypes.values.astype(np.int64)
values2=isapt.values.astype(np.int64)
values3=numapt.values.astype(np.int64)

########
###Quitamos los campos que no nos interesan
del df['isAPT']
del df['MD5']
del df['NUMAPT']

a = [0] * total_muestras
#
df.insert(2, "isWorm", a, True)
#for i in range(0,total_muestras-1):
    #if df['isTypeUnknown'][i] == 1:
                #df['MALWARE_TYPE'][i]=-1
    #if df['isOtherType'][i] == 1:
                #df['MALWARE_TYPE'][i]=0
    #if df['isTrojan'][i] == 1:
                #df['MALWARE_TYPE'][i]=1
    #if df['isWorm'][i] == 1:
    #            df['MALWARE_TYPE'][i]=2
    #if df['isBackdoor'][i] == 1:
                #df['MALWARE_TYPE'][i]=3
    #if df['isRootkit'][i] == 1:
                #df['MALWARE_TYPE'][i]=4
    #if df['isSpyware'][i] == 1:
                #df['MALWARE_TYPE'][i]=5

df1=df[['ANTIDEBUG_FindWindowA','ANTIDEBUG_FindWindowExA','ANTIDEBUG_FindWindowExW','ANTIDEBUG_GetWindowThreadProcessId','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32First','ANTIDEBUG_Process32Next','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DNS_CN','DNS_NL','DNS_US','HAS_OVERLAYS','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateFile','IMPORTS_BIN_CreateFileMapping','IMPORTS_BIN_CreateMutex','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_CreateWindowExA','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_DispatchMessageA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindClose','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_FindResource','IMPORTS_BIN_FindWindow','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetCurrentProcessId','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetDlgItem','IMPORTS_BIN_GetFileAttributes','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetFileType','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalAlloc','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_HeapFree','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_InternetOpen','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_IsWindow','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadLibrary','IMPORTS_BIN_LoadResource','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_MessageBoxA','IMPORTS_BIN_MoveFile','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_OpenFile','IMPORTS_BIN_PostQuitMessage','IMPORTS_BIN_RaiseException','IMPORTS_BIN_ReadFile','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RegCreateKey','IMPORTS_BIN_RegOpenKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_RegSetValue','IMPORTS_BIN_RegSetValueExA','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_ShowWindow','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_TlsSetValue','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WideCharToMultiByte','IMPORTS_BIN_wsprintfA','isOtherType','isRootkit','isSpyware','isTrojan','isTypeUnknown','isWorm','NUM_IMPORTS','NUM_PACKERS','OPENED_FILES_//.','OPENED_FILES_C:','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/Program_Files','OPENED_FILES_C:/Program_Files/Internet_Explorer','OPENED_FILES_C:/WINDOWS','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_C:/WINDOWS/system32/drivers','OPENED_FILES_//./PIPE','PACKER_Armadillo','PACKER_BobSoft','PACKER_MSLRH','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','READ_FILES_C:/Program_Files/Internet_Explorer','READ_FILES_C:/WINDOWS/Registration','READ_FILES_C:/WINDOWS/system32','RESOURCE_NUM','SERVICES_AudioSrv','SERVICES_RASMAN','SERVICES_RemoteAccess','SERVICES_Router','SUSP_API_ConnectNamedPipe','SUSP_API_CopyFileA','SUSP_API_CreateDirectoryW','SUSP_API_CreateFileA','SUSP_API_CreateFileMappingA','SUSP_API_CreateFileW','SUSP_API_CreateProcessW','SUSP_API_CreateServiceA','SUSP_API_CreateThread','SUSP_API_CreateToolhelp32Snapshot','SUSP_API_DeleteFileA','SUSP_API_DeleteFileW','SUSP_API_ExitThread','SUSP_API_FindFirstFileA','SUSP_API_FindFirstFileW','SUSP_API_FindNextFileA','SUSP_API_FindNextFileW','SUSP_API_FindResourceA','SUSP_API_FindResourceW','SUSP_API_FindWindowA','SUSP_API_FindWindowExW','SUSP_API_GetCommandLineA','SUSP_API_GetCommandLineW','SUSP_API_GetComputerNameA','SUSP_API_GetDriveTypeA','SUSP_API_GetFileAttributesExA','SUSP_API_GetFileAttributesW','SUSP_API_GetFileSize','SUSP_API_GetModuleFileNameA','SUSP_API_GetModuleFileNameW','SUSP_API_GetModuleHandleA','SUSP_API_GetModuleHandleW','SUSP_API_GetProcAddress','SUSP_API_GetStartupInfoA','SUSP_API_GetStartupInfoW','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_GetUserNameA','SUSP_API_GetVersionExA','SUSP_API_GetVersionExW','SUSP_API_GetWindowThreadProcessId','SUSP_API_HttpQueryInfoA','SUSP_API_HttpSendRequestA','SUSP_API_InternetCloseHandle','SUSP_API_InternetConnectA','SUSP_API_InternetOpenA','SUSP_API_InternetReadFile','SUSP_API_LoadLibraryA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_LockResource','SUSP_API_OpenProcess','SUSP_API_OpenProcessToken','SUSP_API_OutputDebugStringA','SUSP_API_Process32First','SUSP_API_Process32Next','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyExW','SUSP_API_RegDeleteKeyA','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExA','SUSP_API_RegOpenKeyA','SUSP_API_RegOpenKeyExA','SUSP_API_RegOpenKeyExW','SUSP_API_SetWindowsHookExA','SUSP_API_ShellExecuteA','SUSP_API_ShellExecuteExA','SUSP_API_Sleep','SUSP_API_StartServiceA','SUSP_API_VirtualAlloc','SUSP_API_VirtualAllocEx','SUSP_API_VirtualFree','SUSP_API_VirtualProtect','SUSP_API_WinExec','SUSP_API_WriteFile','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_DLL_EN_BLANCO','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_KERNEL32','SUSP_DLLS_KERNEL32.dll','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_URLMON.DLL','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll','SUSP_DLLS_wininet.dll','SUSP_DLLS_WINMM.DLL','SUSP_DLLS_WINSPOOL.DRV','SUSP_DLLS_ws2_32.dll','SUSP_DLLS_WSOCK32.DLL','TCP_US','UDP_NL','UDP_US']]

#df_sin_malware_type=df[['ALL_FILES_C:','ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft','ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB','ALL_FILES_C:/Program_Files/Windows_NT/Accessories','ANTIDEBUG_CheckRemoteDebuggerPresent','ANTIDEBUG_FindWindowExA','ANTIDEBUG_FindWindowExW','ANTIDEBUG_GetWindowThreadProcessId','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32NextW','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data','DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs','DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop','DELETED_FILES_c:/windows/temp','DNS_CH','DNS_CZ','DNS_IL','DNS_NL','DNS_SY','IMPORTS_BIN_bind','IMPORTS_BIN_CallNextHookEx','IMPORTS_BIN_CharNextA','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateMutex','IMPORTS_BIN_CreateSymbolicLink','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DispatchMessageA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_FindWindow','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetClientRect','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetDlgItem','IMPORTS_BIN_GetFileInformation','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetFileType','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetLongPathName','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GetWindowLongA','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalAlloc','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_HeapFree','IMPORTS_BIN_inet_addr','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadLibrary','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_OpenFile','IMPORTS_BIN_RegOpenKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_RegSetValueExA','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetWindowLongA','IMPORTS_BIN_ShowWindow','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_wsprintfA','OPENED_FILES_C:','OPENED_FILES_C:/Documents_and_Settings/<USER>','OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_c:/windows/temp','OPENED_FILES_//./Global','PACKER_Armadillo','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch','SERVICES_AudioSrv','SERVICES_Ias','SERVICES_NetDDEdsdm','SERVICES_Ntmssvc','SERVICES_RASMAN','SERVICES_Win32','SERVICES_WmiApSrv','SUSP_API_CopyFileA','SUSP_API_CopyFileW','SUSP_API_CreateFileA','SUSP_API_CreateProcessAsUserA','SUSP_API_CreateProcessW','SUSP_API_CreateProcessWithLogonW','SUSP_API_CreateServiceW','SUSP_API_CreateThread','SUSP_API_CryptEncrypt','SUSP_API_DeleteFileA','SUSP_API_DisconnectNamedPipe','SUSP_API_FindFirstFileA','SUSP_API_FindFirstFileExW','SUSP_API_GetCommandLineW','SUSP_API_GetModuleFileNameA','SUSP_API_GetProcAddress','SUSP_API_GetStartupInfoA','SUSP_API_GetStartupInfoW','SUSP_API_GetTempPathW','SUSP_API_GetVersionExA','SUSP_API_HttpSendRequestExA','SUSP_API_HttpSendRequestExW','SUSP_API_InternetConnectA','SUSP_API_InternetOpenA','SUSP_API_InternetOpenUrlA','SUSP_API_InternetQueryOptionA','SUSP_API_LoadLibraryA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_LockResource','SUSP_API_OpenFileMappingW','SUSP_API_OpenProcess','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyW','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExA','SUSP_API_RegOpenKeyExA','SUSP_API_ShellExecuteExA','SUSP_API_SleepEx','SUSP_API_StartServiceA','SUSP_API_StartServiceCtrlDispatcherW','SUSP_API_StartServiceW','SUSP_API_VirtualFree','SUSP_API_WriteFile','SUSP_API_WriteProcessMemory','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_crypt32.dll','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_KERNEL32.dll','SUSP_DLLS_MFC42.DLL','SUSP_DLLS_MSVFW32.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OPENGL32.DLL','SUSP_DLLS_SECUR32.dll','SUSP_DLLS_wininet.dll','SUSP_DLLS_WSOCK32.DLL','TCP_AE','TCP_CH','TCP_CN','TCP_DE','TCP_KR','TCP_MD','TCP_NL','TCP_US','UDP_CL','UDP_GB','UDP_MD','UDP_MT','UDP_US','ALL_FILES_C:/WINDOWS/system32','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','DNS_US','HAS_OVERLAYS','IMPORTS_BIN_CreateFile','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetFileAttributes','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MoveFile','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_ReadFile','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WideCharToMultiByte','NUM_IMPORTS','NUM_LANG','NUM_PACKERS','OPENED_FILES_//.','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/WINDOWS','OPENED_FILES_//./PIPE','READ_FILES_C:/WINDOWS/Registration','READ_FILES_C:/WINDOWS/system32','RESOURCE_NUM','SUSP_API_CreateFileW','SUSP_API_FindNextFileA','SUSP_API_FindResourceA','SUSP_API_GetCommandLineA','SUSP_API_GetFileSize','SUSP_API_GetModuleHandleA','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_RegDeleteKeyA','SUSP_API_ShellExecuteA','SUSP_API_Sleep','SUSP_API_VirtualAlloc','SUSP_API_VirtualProtect','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll','isOtherType','isTrojan','isWorm','isBackdoor','isRootkit','isSpyware']]

#df=df_con_malware_type

df=df1

##################################
# RELLENAMOS VALORES VACIOS
##################################

#from sklearn.impute import SimpleImputer
imp = SimpleImputer(strategy="most_frequent")
X=imp.fit_transform(df)

##################################
# Standarization
##################################
from sklearn import preprocessing
X = preprocessing.scale(df)

##################################
# Preparando Training y Testing sets
##################################
#
total_muestras=4875
total_train_set=3600
total_test_set=total_muestras - total_train_set

#Nos quedamos con los valores, descartando las cabeceras
#df3=df.values
#df=df.values
df3=X
df=X


###########
#X_train son las 3600 primeras muestras. X_test son las 1275 ultimas muestras
#Y_train es un 0 o un 1 por cada una de esas 3600 muestras indicando si se trata de un APT o no
#Y_test es un 0 o un 1 por cada una de esas 1275 muestras indicando si se trata de un APT o no
X_train,X_test,Y_train,Y_test=df[:total_train_set],df[total_train_set+1:],isapt[:total_train_set],isapt[total_train_set+1:]

X_total=df
Y_total_APT=isapt

###########################################
# TARGET VECTORS
###########################################

#Pasamos de valores 0 o 1 a valores true or false:
Y_train_APT=(Y_train == 1)
Y_test_APT=(Y_test == 1)


####################################################################################################################################
#                                          SVC 
####################################################################################################################################
print ("################################################")
print ("             SVC not re-trained")
print ("################################################")

##Y ahora hacemos la prediccion con la funcion de sklearn predict:
y_total_pred=cross_val_predict(svm_clf, X_total, Y_total_APT)

array_scores=cross_val_score(svm_clf, X_total, Y_total_APT, cv=10, scoring="accuracy")*100
print("Hacemos la prediccion con la funcion de sklearn predict 10 foldings: " % array_scores.mean())

###########
# Confusion Matrix
###########

print "\nConfusion Matrix"
print confusion_matrix(Y_total_APT,y_total_pred)

print "\nPrecision Score:"
print precision_score(Y_total_APT,y_total_pred)

print "\nRecall Score:"
print recall_score(Y_total_APT,y_total_pred)


#########################################################################################################################
# ROC Curve # # Esta grafica nos permite decidir cual de los clasificadores son mejores
########################################################################################################################

#######SVM########
y_probabilities_svm=cross_val_predict(svm_clf, X_total, Y_total_APT, cv=10,method="predict_proba")
y_scores_svm=y_probabilities_svm[:,1]
#y_scores_svm = svm_clf.decision_function(X_total)
fpr_svm, tpr_svm, threshold_svm=roc_curve(Y_total_APT,y_scores_svm)
roc_auc = auc(fpr_svm, tpr_svm)
plt.plot(fpr_svm, tpr_svm, linewidth=2, label='Roc Curve de SVC (area= %0.4f)' % roc_auc)
#
######PAINT IT!!########

fig.tight_layout()
plt.plot([0,1],[0,1],"k--")
plt.axis([0,1,0,1])
plt.xlabel("False Positive rate")
plt.ylabel("True Positive rate")
plt.title("PROBABILITIES with previously trained classifiers")
plt.legend()
plt.show()
#plt.savefig('resultados/Roc_Curve_With_Previously_trained_clssifiers.png', bbox_inches='tight')

