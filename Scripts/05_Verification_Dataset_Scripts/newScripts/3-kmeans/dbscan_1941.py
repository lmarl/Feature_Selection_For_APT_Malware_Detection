import numpy as np
from numpy import *
from time import time
import pandas as pd
import sys
from time import time
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.ticker import NullFormatter
from sklearn.decomposition import PCA
from sklearn.cluster import KMeans
from sklearn import manifold
from sklearn.manifold import TSNE
from sklearn.cluster import AffinityPropagation
from sklearn.cluster import MeanShift, estimate_bandwidth
from sklearn.cluster import DBSCAN
from sklearn import metrics
from sklearn.cluster import AgglomerativeClustering
from sklearn.neighbors import kneighbors_graph
import time

##########
#FICHEROS#
##########
input_file= "../datasets/reducido_a_1941_features_without_NaNs_y_19457_rows.csv"
data_dir="../tmp"
data_filename = data_dir + '/tsne_1941_3D_e.npy'
tmp_file="../tmp/dataset_1941.joblib.pkl"
output_file='resultados/kmeans_1941_TSNE_3_groups.png'

#from sklearn.datasets.samples_generator import make_blobs
#centers = [[1, 1], [-1, -1], [1, -1]]
#X, labels_true = make_blobs(n_samples=750, centers=centers, cluster_std=0.4, random_state=0)
#print labels_true
#print labels_true.shape

##########
#ARGUMENTS#
##########
print "Current input/output values are:"
print "         Input File:"+input_file
print "         TMP File:"+tmp_file
print "         Output File:"+output_file
print

start = time.time()
##################################
# PREPARATIVOS
##################################

###Leemos el dataset
df = pd.read_csv(input_file, header = 0, sep=';', dtype={"MD5":object,"FIRST_SEEN":object,"SIZE":int,"NUM_PACKERS":float64,"PACKERS_BIN":float64,"PACKERS_BIN_DIST":float64,"MALWARE_TYPE":object,"NUM_IMPORTS":float64,"IMPORTS_BIN":float64,"IMPORTS_BINARY_DIST":float64,"HAS_OVERLAYS":int,"SUSPICIOUS_DLLS":float64,"SUSPICIOUS_DLLS_DIST":float64,"ANTIDEBUG_BINARY":float64,"ANTIDEBUG_BINARY_DIST":float64,"NUM_LANG":float64,"LANG_BINARY":float64,"LANG_BINARY_DIST":float64,"API_BINARY":float64,"API_BINARY_DIST":float64,"RESOURCE_NUM":int,"SERVICES_BINARY":float64,"SERVICES_BINARY_DIST":float64,"all_files_binary":float64,"all_files_binary_DIST":float64,"all_opened_files_binary":float64,"all_opened_files_binary_DIST":float64,"all_written_files_binary":float64,"all_written_files_binary_DIST":float64,"all_deleted_files_binary":float64,"all_deleted_files_binary_DIST":float64,"all_read_files_binary":float64,"all_read_files_binary_DIST":float64,"UDP_Countries":float64,"UDP_Countries_DIST":float64,"TCP_countries":float64,"TCP_countries_DIST":float64,"DNS_countries":float64,"DNS_countries_DIST":float64,"SSDEEP":int,"IMPHASH":int,"APT":int,"NUM_APT":int})

###Separamos los campos que no nos interesan y campos objetivo
#malwaretypes=df.MALWARE_TYPE
#ssdeeptypes=df.SSDEEP
#imphashtypes=df.IMPHASH
apttypes=df.APT
numapt=df.NUM_APT
#md5=df.MD5

###Quitamos las cabeceras de los campos objetivo
#values=malwaretypes.values.astype(np.int64)
isAPT=apttypes.values.astype(np.int64)
values3=numapt.values.astype(np.int64)

#print isAPT
#print isAPT.shape

end = time.time()
print(end - start)
start = time.time()
###Quitamos los campos que no nos interesan
#del df['MALWARE_TYPE']
del df['APT']
#del df['MD5']
#del df['FIRST_SEEN']
#del df['SSDEEP']
#del df['IMPHASH']
del df['NUM_APT']

#df['DATE'] = df['FIRST_SEEN'].apply(convert_to_year)
#print (df['Date'])

#del df['FIRST_SEEN']
#del df['DATE']

print df.shape

##################################
# Standarization
##################################
print ("Standarization process...")
end = time.time()
print(end - start)
start = time.time()
from sklearn import preprocessing
X = preprocessing.scale(df)

#joblib.dump(X, tmp_file)


##################################
# KMEANS
##################################
print ("Kmeans process...")
end = time.time()
print(end - start)
start = time.time()
###Creamos la figura
fig = plt.figure(figsize=(15, 15))
n_clusters_=3
reduced_data=X

###Calculamos el KNN:
kmeans = KMeans(n_clusters=n_clusters_, random_state=0).fit(reduced_data)

#df3=pd.DataFrame(data=reduced_data[0:,0:], index=range(0,reduced_data[1:,0], columns=reduced_data[0,1:])
df3=pd.DataFrame(data=reduced_data)
#pd.DataFrame(data=data[1:,1:],    # values
#...              index=data[1:,0],    # 1st column as index
#...              columns=data[0,1:])

#print(df3)
##############################################################
#kmeans = AffinityPropagation(preference=-50).fit(reduced_data)

##############################################################
#bandwidth = estimate_bandwidth(reduced_data, quantile=0.9, n_samples=500)
#kmeans = MeanShift(bandwidth=bandwidth, bin_seeding=True)
#kmeans.fit(reduced_data)

print ("Kmeans predicting...")
end = time.time()
print(end - start)
start = time.time()
predict=kmeans.predict(reduced_data)
df3['estimated_cluster']=pd.Series(predict, index=df3.index)
values4=pd.Series(predict, index=df3.index)

print ("Calculando TSNE...")
end = time.time()
print(end - start)
start = time.time()

Y = np.load(data_filename)

print ("Pintando...")
end = time.time()
print(end - start)
start = time.time()
###Pintamos los clusters
ax = fig.add_subplot(111, projection='3d')

#ax.scatter(reduced_data[:, 0], reduced_data[:, 1], reduced_data[:,2], cmap=plt.cm.Spectral, s=2, c=kmeans.labels_.astype(float))
ax.scatter(Y[:, 0], Y[:, 1], Y[:,2], cmap=plt.cm.Spectral, s=2, c=values4)

###Y pintamos los centroides
#centroids = kmeans.cluster_centers_
#ax.scatter(centroids[:, 0], centroids[:, 1], centroids[:,2],marker='x', s=169, linewidths=3, color='black', zorder=10)
#plt.title("Kmeans with %s groups" % (num+1) );
plt.title('Estimated number of clusters: %d' % n_clusters_)


##################################
# SHOW PLOT
##################################
#ax.xaxis.set_major_formatter(NullFormatter())
#ax.yaxis.set_major_formatter(NullFormatter())
plt.axis('tight')
fig.savefig(output_file)
plt.show()
