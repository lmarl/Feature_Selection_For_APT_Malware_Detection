import numpy as np
from numpy import *
import pandas as pd
from time import time
import matplotlib.pyplot as plt
from mpl_toolkits.mplot3d import Axes3D
from matplotlib.ticker import NullFormatter
from pandas.plotting import scatter_matrix
from sklearn.externals import joblib

from sklearn import manifold
import sys

def get_redundant_pairs(df):
    '''Get diagonal and lower triangular pairs of correlation matrix'''
    pairs_to_drop = set()
    cols = df.columns
    for i in range(0, df.shape[1]):
        for j in range(0, i+1):
            pairs_to_drop.add((cols[i], cols[j]))
    return pairs_to_drop

def get_top_abs_correlations(df, n=5):
    au_corr = df.corr().abs().unstack()
    labels_to_drop = get_redundant_pairs(df)
    au_corr = au_corr.drop(labels=labels_to_drop, errors="ignore").sort_values(ascending=False)
    return au_corr[0:n]

def syntax_error():
        print "SYNTAX ERROR: Introduce un argumento con los siguientes posibles valores"
        print "Primer argumento:"
        print " 1 Mostrar las 25 mayores correlaciones entre features"
        print " 2 Mostrar el heatmap completo"
        print " 4 Mostrar la correlacion media de cada campo ordenada"
        print " 5 Mostrarlo TODO"
        print


argumentos=sys.argv
if len(argumentos)!=2:
        syntax_error()
        sys.exit()
else:
        if (argumentos[1]!='1' and argumentos[1]!='2' and argumentos[1]!='3' and argumentos[1]!='4' and argumentos[1]!='5'):
                syntax_error()
                sys.exit()


###LEEMOS EL DATASET
input_file= "../datasets/reducido_a_1941_features_without_NaNs_y_19457_rows.csv"
output_file="resultados/correlation_heatmap_1941.png"

df = pd.read_csv(input_file, header = 0, sep=';', dtype={"MD5":object,"FIRST_SEEN":object,"SIZE":int,"NUM_PACKERS":float64,"PACKERS_BIN":float64,"PACKERS_BIN_DIST":float64,"MALWARE_TYPE":object,"NUM_IMPORTS":float64,"IMPORTS_BIN":float64,"IMPORTS_BINARY_DIST":float64,"HAS_OVERLAYS":int,"SUSPICIOUS_DLLS":float64,"SUSPICIOUS_DLLS_DIST":float64,"ANTIDEBUG_BINARY":float64,"ANTIDEBUG_BINARY_DIST":float64,"NUM_LANG":float64,"LANG_BINARY":float64,"LANG_BINARY_DIST":float64,"API_BINARY":float64,"API_BINARY_DIST":float64,"RESOURCE_NUM":int,"SERVICES_BINARY":float64,"SERVICES_BINARY_DIST":float64,"all_files_binary":float64,"all_files_binary_DIST":float64,"all_opened_files_binary":float64,"all_opened_files_binary_DIST":float64,"all_written_files_binary":float64,"all_written_files_binary_DIST":float64,"all_deleted_files_binary":float64,"all_deleted_files_binary_DIST":float64,"all_read_files_binary":float64,"all_read_files_binary_DIST":float64,"UDP_Countries":float64,"UDP_Countries_DIST":float64,"TCP_countries":float64,"TCP_countries_DIST":float64,"DNS_countries":float64,"DNS_countries_DIST":float64,"SSDEEP":int,"IMPHASH":int,"APT":int,"NUM_APT":int}) 

apttypes=df.APT
numapt=df.NUM_APT

values2=apttypes.values.astype(np.int64)
values3=numapt.values.astype(np.int64)

del df['APT']
del df['NUM_APT']

#
#NOS QUEDAMOS CON LAS 230 FEATURES QUE SE HAN SELECCIONADO EN EL APARTADO ANTERIOR. Si queremos dejarlo como estaba solo hay que quitar las siguientes lineas
#

##ORIGINAL
#df1=df[['ALL_FILES_C:','ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft','ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB','ALL_FILES_C:/Program_Files/Windows_NT/Accessories','ANTIDEBUG_CheckRemoteDebuggerPresent','ANTIDEBUG_FindWindowExA','ANTIDEBUG_FindWindowExW','ANTIDEBUG_GetWindowThreadProcessId','ANTIDEBUG_%IsDebuggerPresent','ANTIDEBUG_OutputDebugStringA','ANTIDEBUG_Process32NextW','DELETED_FILES_C:','DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data','DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs','DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop','DELETED_FILES_c:/windows/temp','DNS_CH','DNS_CZ','DNS_IL','DNS_NL','DNS_SY','IMPORTS_BIN_bind','IMPORTS_BIN_CallNextHookEx','IMPORTS_BIN_CharNextA','IMPORTS_BIN_CloseHandle','IMPORTS_BIN_CopyFile','IMPORTS_BIN_CreateDirectoryA','IMPORTS_BIN_CreateMutex','IMPORTS_BIN_CreateSymbolicLink','IMPORTS_BIN_DeleteCriticalSection','IMPORTS_BIN_DispatchMessageA','IMPORTS_BIN_EnterCriticalSection','IMPORTS_BIN_FindNextFile','IMPORTS_BIN_FindWindow','IMPORTS_BIN_FreeLibrary','IMPORTS_BIN_GetClientRect','IMPORTS_BIN_GetCurrentThreadId','IMPORTS_BIN_GetDC','IMPORTS_BIN_GetDeviceCaps','IMPORTS_BIN_GetDlgItem','IMPORTS_BIN_GetFileInformation','IMPORTS_BIN_GetFileTime','IMPORTS_BIN_GetFileType','IMPORTS_BIN_GetLastError','IMPORTS_BIN_GetLongPathName','IMPORTS_BIN_GetSystemDirectoryA','IMPORTS_BIN_GetTempPathA','IMPORTS_BIN_GetVersion','IMPORTS_BIN_GetWindowLongA','IMPORTS_BIN_GetWindowsDirectory','IMPORTS_BIN_GlobalAlloc','IMPORTS_BIN_GlobalFree','IMPORTS_BIN_GlobalUnlock','IMPORTS_BIN_HeapFree','IMPORTS_BIN_inet_addr','IMPORTS_BIN_InitializeCriticalSection','IMPORTS_BIN_IsDebuggerPresent','IMPORTS_BIN_LeaveCriticalSection','IMPORTS_BIN_LoadLibrary','IMPORTS_BIN_lstrcpynA','IMPORTS_BIN_MapViewOfFile','IMPORTS_BIN_OpenFile','IMPORTS_BIN_RegOpenKey','IMPORTS_BIN_RegQueryValueExA','IMPORTS_BIN_RegSetValueExA','IMPORTS_BIN_SelectObject','IMPORTS_BIN_SetFilePointer','IMPORTS_BIN_SetWindowLongA','IMPORTS_BIN_ShowWindow','IMPORTS_BIN_TlsGetValue','IMPORTS_BIN_wsprintfA','OPENED_FILES_C:','OPENED_FILES_C:/Documents_and_Settings/<USER>','OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup','OPENED_FILES_C:/WINDOWS/Registration','OPENED_FILES_C:/WINDOWS/system','OPENED_FILES_C:/WINDOWS/system32','OPENED_FILES_c:/windows/temp','OPENED_FILES_//./Global','PACKER_Armadillo','PACKER_NullSoft','PACKER_UPX','READ_FILES_C:','READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch','SERVICES_AudioSrv','SERVICES_Ias','SERVICES_NetDDEdsdm','SERVICES_Ntmssvc','SERVICES_RASMAN','SERVICES_Win32','SERVICES_WmiApSrv','SUSP_API_CopyFileA','SUSP_API_CopyFileW','SUSP_API_CreateFileA','SUSP_API_CreateProcessAsUserA','SUSP_API_CreateProcessW','SUSP_API_CreateProcessWithLogonW','SUSP_API_CreateServiceW','SUSP_API_CreateThread','SUSP_API_CryptEncrypt','SUSP_API_DeleteFileA','SUSP_API_DisconnectNamedPipe','SUSP_API_FindFirstFileA','SUSP_API_FindFirstFileExW','SUSP_API_GetCommandLineW','SUSP_API_GetModuleFileNameA','SUSP_API_GetProcAddress','SUSP_API_GetStartupInfoA','SUSP_API_GetStartupInfoW','SUSP_API_GetTempPathW','SUSP_API_GetVersionExA','SUSP_API_HttpSendRequestExA','SUSP_API_HttpSendRequestExW','SUSP_API_InternetConnectA','SUSP_API_InternetOpenA','SUSP_API_InternetOpenUrlA','SUSP_API_InternetQueryOptionA','SUSP_API_LoadLibraryA','SUSP_API_LoadLibraryExA','SUSP_API_LoadLibraryW','SUSP_API_LockResource','SUSP_API_OpenFileMappingW','SUSP_API_OpenProcess','SUSP_API_RegCreateKeyExA','SUSP_API_RegCreateKeyW','SUSP_API_RegDeleteValueA','SUSP_API_RegEnumKeyA','SUSP_API_RegEnumKeyExA','SUSP_API_RegOpenKeyExA','SUSP_API_ShellExecuteExA','SUSP_API_SleepEx','SUSP_API_StartServiceA','SUSP_API_StartServiceCtrlDispatcherW','SUSP_API_StartServiceW','SUSP_API_VirtualFree','SUSP_API_WriteFile','SUSP_API_WriteProcessMemory','SUSP_DLLS_ADVAPI32.dll','SUSP_DLLS_comdlg32.dll','SUSP_DLLS_crypt32.dll','SUSP_DLLS_GDI32.DLL','SUSP_DLLS_HAL.dll','SUSP_DLLS_KERNEL32.dll','SUSP_DLLS_MFC42.DLL','SUSP_DLLS_MSVFW32.dll','SUSP_DLLS_ntoskrnl.exe','SUSP_DLLS_OLE32.DLL','SUSP_DLLS_OPENGL32.DLL','SUSP_DLLS_SECUR32.dll','SUSP_DLLS_wininet.dll','SUSP_DLLS_WSOCK32.DLL','TCP_AE','TCP_CH','TCP_CN','TCP_DE','TCP_KR','TCP_MD','TCP_NL','TCP_US','UDP_CL','UDP_GB','UDP_MD','UDP_MT','UDP_US','ALL_FILES_C:/WINDOWS/system32','ANTIDEBUG_TerminateProcess','ANTIDEBUG_UnhandledExceptionFilter','DNS_US','HAS_OVERLAYS','IMPORTS_BIN_CreateFile','IMPORTS_BIN_CreateProcessA','IMPORTS_BIN_DeleteFile','IMPORTS_BIN_DeleteObject','IMPORTS_BIN_ExitProcess','IMPORTS_BIN_FileSize','IMPORTS_BIN_FindFirstFile','IMPORTS_BIN_GetACP','IMPORTS_BIN_GetCPInfo','IMPORTS_BIN_GetCurrentProcess','IMPORTS_BIN_GetFileAttributes','IMPORTS_BIN_GetFileAttributesA','IMPORTS_BIN_GetFullPathName','IMPORTS_BIN_GetShortPathName','IMPORTS_BIN_GetStdHandle','IMPORTS_BIN_GetTempFileName','IMPORTS_BIN_GlobalLock','IMPORTS_BIN_HeapAlloc','IMPORTS_BIN_lstrlenA','IMPORTS_BIN_MoveFile','IMPORTS_BIN_MultiByteToWideChar','IMPORTS_BIN_ReadFile','IMPORTS_BIN_RegCloseKey','IMPORTS_BIN_RtlUnwind','IMPORTS_BIN_SetErrorMode','IMPORTS_BIN_SetFileAttributes','IMPORTS_BIN_SetFileTime','IMPORTS_BIN_WaitForSingleObject','IMPORTS_BIN_WideCharToMultiByte','MALWARE_TYPE','NUM_IMPORTS','NUM_LANG','NUM_PACKERS','OPENED_FILES_//.','OPENED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp','OPENED_FILES_C:/WINDOWS','OPENED_FILES_//./PIPE','READ_FILES_C:/WINDOWS/Registration','READ_FILES_C:/WINDOWS/system32','RESOURCE_NUM','SUSP_API_CreateFileW','SUSP_API_FindNextFileA','SUSP_API_FindResourceA','SUSP_API_GetCommandLineA','SUSP_API_GetFileSize','SUSP_API_GetModuleHandleA','SUSP_API_GetTempFileNameA','SUSP_API_GetTickCount','SUSP_API_RegDeleteKeyA','SUSP_API_ShellExecuteA','SUSP_API_Sleep','SUSP_API_VirtualAlloc','SUSP_API_VirtualProtect','SUSP_DLLS_COMCTL32.DLL','SUSP_DLLS_Msvcrt.dll','SUSP_DLLS_OLEAUT32.DLL','SUSP_DLLS_Shell32.dll','SUSP_DLLS_SHLWAPI.dll','SUSP_DLLS_USER32.dll','SUSP_DLLS_version.dll']]


##ORDENADOS ALFABETICAMENTE
#df1=df[['ALL_FILES_C:', 'ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft', 'ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB', 'ALL_FILES_C:/Program_Files/Windows_NT/Accessories', 'ALL_FILES_C:/WINDOWS/system32', 'ANTIDEBUG_CheckRemoteDebuggerPresent', 'ANTIDEBUG_FindWindowExA', 'ANTIDEBUG_FindWindowExW', 'ANTIDEBUG_GetWindowThreadProcessId', 'ANTIDEBUG_%IsDebuggerPresent', 'ANTIDEBUG_OutputDebugStringA', 'ANTIDEBUG_Process32NextW', 'ANTIDEBUG_TerminateProcess', 'ANTIDEBUG_UnhandledExceptionFilter', 'DELETED_FILES_C:', 'DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs', 'DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop', 'DELETED_FILES_c:/windows/temp', 'DNS_CH', 'DNS_CZ', 'DNS_IL', 'DNS_NL', 'DNS_SY', 'DNS_US', 'HAS_OVERLAYS', 'IMPORTS_BIN_bind', 'IMPORTS_BIN_CallNextHookEx', 'IMPORTS_BIN_CharNextA', 'IMPORTS_BIN_CloseHandle', 'IMPORTS_BIN_CopyFile', 'IMPORTS_BIN_CreateDirectoryA', 'IMPORTS_BIN_CreateFile', 'IMPORTS_BIN_CreateMutex', 'IMPORTS_BIN_CreateProcessA', 'IMPORTS_BIN_CreateSymbolicLink', 'IMPORTS_BIN_DeleteCriticalSection', 'IMPORTS_BIN_DeleteFile', 'IMPORTS_BIN_DeleteObject', 'IMPORTS_BIN_DispatchMessageA', 'IMPORTS_BIN_EnterCriticalSection', 'IMPORTS_BIN_ExitProcess', 'IMPORTS_BIN_FileSize', 'IMPORTS_BIN_FindFirstFile', 'IMPORTS_BIN_FindNextFile', 'IMPORTS_BIN_FindWindow', 'IMPORTS_BIN_FreeLibrary', 'IMPORTS_BIN_GetACP', 'IMPORTS_BIN_GetClientRect', 'IMPORTS_BIN_GetCPInfo', 'IMPORTS_BIN_GetCurrentProcess', 'IMPORTS_BIN_GetCurrentThreadId', 'IMPORTS_BIN_GetDC', 'IMPORTS_BIN_GetDeviceCaps', 'IMPORTS_BIN_GetFileAttributes', 'IMPORTS_BIN_GetFileAttributesA', 'IMPORTS_BIN_GetFullPathName', 'IMPORTS_BIN_GetDlgItem', 'IMPORTS_BIN_GetFileInformation', 'IMPORTS_BIN_GetFileTime', 'IMPORTS_BIN_GetFileType', 'IMPORTS_BIN_GetLastError', 'IMPORTS_BIN_GetLongPathName', 'IMPORTS_BIN_GetShortPathName', 'IMPORTS_BIN_GetStdHandle', 'IMPORTS_BIN_GetSystemDirectoryA', 'IMPORTS_BIN_GetTempPathA', 'IMPORTS_BIN_GetTempFileName', 'IMPORTS_BIN_GetVersion', 'IMPORTS_BIN_GetWindowLongA', 'IMPORTS_BIN_GetWindowsDirectory', 'IMPORTS_BIN_GlobalAlloc', 'IMPORTS_BIN_GlobalLock', 'IMPORTS_BIN_GlobalFree', 'IMPORTS_BIN_GlobalUnlock', 'IMPORTS_BIN_HeapAlloc', 'IMPORTS_BIN_HeapFree', 'IMPORTS_BIN_inet_addr', 'IMPORTS_BIN_InitializeCriticalSection', 'IMPORTS_BIN_IsDebuggerPresent', 'IMPORTS_BIN_LeaveCriticalSection', 'IMPORTS_BIN_LoadLibrary', 'IMPORTS_BIN_lstrcpynA', 'IMPORTS_BIN_lstrlenA', 'IMPORTS_BIN_MapViewOfFile', 'IMPORTS_BIN_MoveFile', 'IMPORTS_BIN_MultiByteToWideChar', 'IMPORTS_BIN_OpenFile', 'IMPORTS_BIN_RegOpenKey', 'IMPORTS_BIN_RegQueryValueExA', 'IMPORTS_BIN_RegSetValueExA', 'IMPORTS_BIN_ReadFile', 'IMPORTS_BIN_RegCloseKey', 'IMPORTS_BIN_RtlUnwind', 'IMPORTS_BIN_SelectObject', 'IMPORTS_BIN_SetErrorMode', 'IMPORTS_BIN_SetFileAttributes', 'IMPORTS_BIN_SetFilePointer', 'IMPORTS_BIN_SetFileTime', 'IMPORTS_BIN_SetWindowLongA', 'IMPORTS_BIN_ShowWindow', 'IMPORTS_BIN_TlsGetValue', 'IMPORTS_BIN_WaitForSingleObject', 'IMPORTS_BIN_WideCharToMultiByte', 'IMPORTS_BIN_wsprintfA', 'MALWARE_TYPE', 'NUM_IMPORTS', 'NUM_LANG', 'NUM_PACKERS', 'OPENED_FILES_C:', 'OPENED_FILES_//./Global', 'OPENED_FILES_//./PIPE', 'OPENED_FILES_C:/WINDOWS', 'OPENED_FILES_C:/Documents_and_Settings/<USER>', 'OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup', 'OPENED_FILES_C:/WINDOWS/Registration', 'OPENED_FILES_C:/WINDOWS/system', 'OPENED_FILES_C:/WINDOWS/system32', 'OPENED_FILES_c:/windows/temp', 'PACKER_Armadillo', 'PACKER_NullSoft', 'PACKER_UPX', 'READ_FILES_C:', 'READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch', 'READ_FILES_C:/WINDOWS/Registration', 'READ_FILES_C:/WINDOWS/system32', 'RESOURCE_NUM', 'SERVICES_AudioSrv', 'SERVICES_Ias', 'SERVICES_NetDDEdsdm', 'SERVICES_Ntmssvc', 'SERVICES_RASMAN', 'SERVICES_Win32', 'SERVICES_WmiApSrv', 'SUSP_API_CopyFileA', 'SUSP_API_CopyFileW', 'SUSP_API_CreateFileA', 'SUSP_API_CreateFileW', 'SUSP_API_CreateProcessAsUserA', 'SUSP_API_CreateProcessW', 'SUSP_API_CreateProcessWithLogonW', 'SUSP_API_CreateServiceW', 'SUSP_API_CreateThread', 'SUSP_API_CryptEncrypt', 'SUSP_API_DeleteFileA', 'SUSP_API_DisconnectNamedPipe', 'SUSP_API_FindFirstFileA', 'SUSP_API_FindFirstFileExW', 'SUSP_API_FindNextFileA', 'SUSP_API_FindResourceA', 'SUSP_API_GetCommandLineW', 'SUSP_API_GetCommandLineA', 'SUSP_API_GetFileSize', 'SUSP_API_GetModuleFileNameA', 'SUSP_API_GetModuleHandleA', 'SUSP_API_GetProcAddress', 'SUSP_API_GetStartupInfoA', 'SUSP_API_GetStartupInfoW', 'SUSP_API_GetTempFileNameA', 'SUSP_API_GetTempPathW', 'SUSP_API_GetTickCount', 'SUSP_API_GetVersionExA', 'SUSP_API_HttpSendRequestExA', 'SUSP_API_HttpSendRequestExW', 'SUSP_API_InternetConnectA', 'SUSP_API_InternetOpenA', 'SUSP_API_InternetOpenUrlA', 'SUSP_API_InternetQueryOptionA', 'SUSP_API_LoadLibraryA', 'SUSP_API_LoadLibraryExA', 'SUSP_API_LoadLibraryW', 'SUSP_API_LockResource', 'SUSP_API_OpenFileMappingW', 'SUSP_API_OpenProcess', 'SUSP_API_RegCreateKeyExA', 'SUSP_API_RegCreateKeyW', 'SUSP_API_RegDeleteKeyA', 'SUSP_API_RegDeleteValueA', 'SUSP_API_RegEnumKeyA', 'SUSP_API_RegEnumKeyExA', 'SUSP_API_RegOpenKeyExA', 'SUSP_API_ShellExecuteA', 'SUSP_API_ShellExecuteExA', 'SUSP_API_Sleep', 'SUSP_API_SleepEx', 'SUSP_API_StartServiceA', 'SUSP_API_StartServiceCtrlDispatcherW', 'SUSP_API_StartServiceW', 'SUSP_API_VirtualAlloc', 'SUSP_API_VirtualFree', 'SUSP_API_VirtualProtect', 'SUSP_API_WriteFile', 'SUSP_API_WriteProcessMemory', 'SUSP_DLLS_COMCTL32.DLL', 'SUSP_DLLS_Msvcrt.dll', 'SUSP_DLLS_OLEAUT32.DLL', 'SUSP_DLLS_Shell32.dll', 'SUSP_DLLS_SHLWAPI.dll', 'SUSP_DLLS_ADVAPI32.dll', 'SUSP_DLLS_comdlg32.dll', 'SUSP_DLLS_crypt32.dll', 'SUSP_DLLS_GDI32.DLL', 'SUSP_DLLS_HAL.dll', 'SUSP_DLLS_KERNEL32.dll', 'SUSP_DLLS_MFC42.DLL', 'SUSP_DLLS_MSVFW32.dll', 'SUSP_DLLS_ntoskrnl.exe', 'SUSP_DLLS_OLE32.DLL', 'SUSP_DLLS_OPENGL32.DLL', 'SUSP_DLLS_SECUR32.dll', 'SUSP_DLLS_USER32.dll', 'SUSP_DLLS_version.dll', 'SUSP_DLLS_wininet.dll', 'SUSP_DLLS_WSOCK32.DLL', 'TCP_AE', 'TCP_CH', 'TCP_CN', 'TCP_DE', 'TCP_KR', 'TCP_MD', 'TCP_NL', 'TCP_US', 'UDP_CL', 'UDP_GB', 'UDP_MD', 'UDP_MT', 'UDP_US']]

#df1=df[['ALL_FILES_C:', 'ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft', 'ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB', 'ALL_FILES_C:/Program_Files/Windows_NT/Accessories', 'ALL_FILES_C:/WINDOWS/system32', 'ANTIDEBUG_CheckRemoteDebuggerPresent', 'ANTIDEBUG_FindWindowExA', 'ANTIDEBUG_FindWindowExW', 'ANTIDEBUG_GetWindowThreadProcessId', 'ANTIDEBUG_%IsDebuggerPresent', 'ANTIDEBUG_OutputDebugStringA', 'ANTIDEBUG_Process32NextW', 'ANTIDEBUG_TerminateProcess', 'ANTIDEBUG_UnhandledExceptionFilter', 'DELETED_FILES_C:', 'DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs', 'DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop', 'DELETED_FILES_c:/windows/temp', 'DNS_CH', 'DNS_CZ', 'DNS_IL', 'DNS_NL', 'DNS_SY', 'DNS_US', 'HAS_OVERLAYS', 'IMPORTS_BIN_bind', 'IMPORTS_BIN_CallNextHookEx', 'IMPORTS_BIN_CharNextA', 'IMPORTS_BIN_CloseHandle', 'IMPORTS_BIN_CopyFile', 'IMPORTS_BIN_CreateDirectoryA', 'IMPORTS_BIN_CreateFile', 'IMPORTS_BIN_CreateMutex', 'IMPORTS_BIN_CreateProcessA', 'IMPORTS_BIN_CreateSymbolicLink', 'IMPORTS_BIN_DeleteCriticalSection', 'IMPORTS_BIN_DeleteFile', 'IMPORTS_BIN_DeleteObject', 'IMPORTS_BIN_DispatchMessageA', 'IMPORTS_BIN_EnterCriticalSection', 'IMPORTS_BIN_ExitProcess', 'IMPORTS_BIN_FileSize', 'IMPORTS_BIN_FindFirstFile', 'IMPORTS_BIN_FindNextFile', 'IMPORTS_BIN_FindWindow', 'IMPORTS_BIN_FreeLibrary', 'IMPORTS_BIN_GetACP', 'IMPORTS_BIN_GetClientRect', 'IMPORTS_BIN_GetCPInfo', 'IMPORTS_BIN_GetCurrentProcess', 'IMPORTS_BIN_GetCurrentThreadId', 'IMPORTS_BIN_GetDC', 'IMPORTS_BIN_GetDeviceCaps', 'IMPORTS_BIN_GetFileAttributes', 'IMPORTS_BIN_GetFileAttributesA', 'IMPORTS_BIN_GetFullPathName', 'IMPORTS_BIN_GetDlgItem', 'IMPORTS_BIN_GetFileInformation', 'IMPORTS_BIN_GetFileTime', 'IMPORTS_BIN_GetFileType', 'IMPORTS_BIN_GetLastError', 'IMPORTS_BIN_GetLongPathName', 'IMPORTS_BIN_GetShortPathName', 'IMPORTS_BIN_GetStdHandle', 'IMPORTS_BIN_GetSystemDirectoryA', 'IMPORTS_BIN_GetTempPathA', 'IMPORTS_BIN_GetTempFileName', 'IMPORTS_BIN_GetVersion', 'IMPORTS_BIN_GetWindowLongA', 'IMPORTS_BIN_GetWindowsDirectory', 'IMPORTS_BIN_GlobalAlloc', 'IMPORTS_BIN_GlobalLock', 'IMPORTS_BIN_GlobalFree', 'IMPORTS_BIN_GlobalUnlock', 'IMPORTS_BIN_HeapAlloc', 'IMPORTS_BIN_HeapFree', 'IMPORTS_BIN_inet_addr', 'IMPORTS_BIN_InitializeCriticalSection', 'IMPORTS_BIN_IsDebuggerPresent', 'IMPORTS_BIN_LeaveCriticalSection', 'IMPORTS_BIN_LoadLibrary', 'IMPORTS_BIN_lstrcpynA', 'IMPORTS_BIN_lstrlenA', 'IMPORTS_BIN_MapViewOfFile', 'IMPORTS_BIN_MoveFile', 'IMPORTS_BIN_MultiByteToWideChar', 'IMPORTS_BIN_OpenFile', 'IMPORTS_BIN_RegOpenKey', 'IMPORTS_BIN_RegQueryValueExA', 'IMPORTS_BIN_RegSetValueExA', 'IMPORTS_BIN_ReadFile', 'IMPORTS_BIN_RegCloseKey', 'IMPORTS_BIN_RtlUnwind', 'IMPORTS_BIN_SelectObject', 'IMPORTS_BIN_SetErrorMode', 'IMPORTS_BIN_SetFileAttributes', 'IMPORTS_BIN_SetFilePointer', 'IMPORTS_BIN_SetFileTime', 'IMPORTS_BIN_SetWindowLongA', 'IMPORTS_BIN_ShowWindow', 'IMPORTS_BIN_TlsGetValue', 'IMPORTS_BIN_WaitForSingleObject', 'IMPORTS_BIN_WideCharToMultiByte', 'IMPORTS_BIN_wsprintfA', 'MALWARE_TYPE', 'NUM_IMPORTS', 'NUM_LANG', 'NUM_PACKERS', 'OPENED_FILES_C:', 'OPENED_FILES_//./Global', 'OPENED_FILES_//./PIPE', 'OPENED_FILES_C:/WINDOWS', 'OPENED_FILES_C:/Documents_and_Settings/<USER>', 'OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup', 'OPENED_FILES_C:/WINDOWS/Registration', 'OPENED_FILES_C:/WINDOWS/system', 'OPENED_FILES_C:/WINDOWS/system32', 'OPENED_FILES_c:/windows/temp', 'PACKER_Armadillo', 'PACKER_NullSoft', 'PACKER_UPX', 'READ_FILES_C:', 'READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch', 'READ_FILES_C:/WINDOWS/Registration', 'READ_FILES_C:/WINDOWS/system32', 'RESOURCE_NUM', 'SERVICES_AudioSrv', 'SERVICES_Ias', 'SERVICES_NetDDEdsdm', 'SERVICES_Ntmssvc', 'SERVICES_RASMAN', 'SERVICES_Win32', 'SERVICES_WmiApSrv', 'SUSP_API_CopyFileA', 'SUSP_API_CopyFileW', 'SUSP_API_CreateFileA', 'SUSP_API_CreateFileW', 'SUSP_API_CreateProcessAsUserA', 'SUSP_API_CreateProcessW', 'SUSP_API_CreateProcessWithLogonW', 'SUSP_API_CreateServiceW', 'SUSP_API_CreateThread', 'SUSP_API_CryptEncrypt', 'SUSP_API_DeleteFileA', 'SUSP_API_DisconnectNamedPipe', 'SUSP_API_FindFirstFileA', 'SUSP_API_FindFirstFileExW', 'SUSP_API_FindNextFileA', 'SUSP_API_FindResourceA', 'SUSP_API_GetCommandLineW', 'SUSP_API_GetCommandLineA', 'SUSP_API_GetFileSize', 'SUSP_API_GetModuleFileNameA', 'SUSP_API_GetModuleHandleA', 'SUSP_API_GetProcAddress', 'SUSP_API_GetStartupInfoA', 'SUSP_API_GetStartupInfoW', 'SUSP_API_GetTempFileNameA', 'SUSP_API_GetTempPathW', 'SUSP_API_GetTickCount', 'SUSP_API_GetVersionExA', 'SUSP_API_HttpSendRequestExA', 'SUSP_API_HttpSendRequestExW', 'SUSP_API_InternetConnectA', 'SUSP_API_InternetOpenA', 'SUSP_API_InternetOpenUrlA', 'SUSP_API_InternetQueryOptionA', 'SUSP_API_LoadLibraryA', 'SUSP_API_LoadLibraryExA', 'SUSP_API_LoadLibraryW', 'SUSP_API_LockResource', 'SUSP_API_OpenFileMappingW', 'SUSP_API_OpenProcess', 'SUSP_API_RegCreateKeyExA', 'SUSP_API_RegCreateKeyW', 'SUSP_API_RegDeleteKeyA', 'SUSP_API_RegDeleteValueA', 'SUSP_API_RegEnumKeyA', 'SUSP_API_RegEnumKeyExA', 'SUSP_API_RegOpenKeyExA', 'SUSP_API_ShellExecuteA', 'SUSP_API_ShellExecuteExA', 'SUSP_API_Sleep', 'SUSP_API_SleepEx', 'SUSP_API_StartServiceA', 'SUSP_API_StartServiceCtrlDispatcherW', 'SUSP_API_StartServiceW', 'SUSP_API_VirtualAlloc', 'SUSP_API_VirtualFree', 'SUSP_API_VirtualProtect', 'SUSP_API_WriteFile', 'SUSP_API_WriteProcessMemory', 'SUSP_DLLS_COMCTL32.DLL', 'SUSP_DLLS_Msvcrt.dll', 'SUSP_DLLS_OLEAUT32.DLL', 'SUSP_DLLS_Shell32.dll', 'SUSP_DLLS_SHLWAPI.dll', 'SUSP_DLLS_ADVAPI32.dll', 'SUSP_DLLS_comdlg32.dll', 'SUSP_DLLS_crypt32.dll', 'SUSP_DLLS_GDI32.DLL', 'SUSP_DLLS_HAL.dll', 'SUSP_DLLS_KERNEL32.dll', 'SUSP_DLLS_MFC42.DLL', 'SUSP_DLLS_MSVFW32.dll', 'SUSP_DLLS_ntoskrnl.exe', 'SUSP_DLLS_OLE32.DLL', 'SUSP_DLLS_OPENGL32.DLL', 'SUSP_DLLS_SECUR32.dll', 'SUSP_DLLS_USER32.dll', 'SUSP_DLLS_version.dll', 'SUSP_DLLS_wininet.dll', 'SUSP_DLLS_WSOCK32.DLL', 'TCP_AE', 'TCP_CH', 'TCP_CN', 'TCP_DE', 'TCP_KR', 'TCP_MD', 'TCP_NL', 'TCP_US', 'UDP_CL', 'UDP_GB', 'UDP_MD', 'UDP_MT', 'UDP_US']]
##POR TIPOS

df1=df[['ALL_FILES_C:', 'ALL_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft', 'ALL_FILES_C:/Program_Files/Common_Files/System/Ole_DB', 'ALL_FILES_C:/Program_Files/Windows_NT/Accessories', 'ALL_FILES_C:/WINDOWS/system32', 'DELETED_FILES_C:', 'DELETED_FILES_C:/DOCUME~1/<USER>~1/LOCALS~1/Temp', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Application_Data', 'DELETED_FILES_C:/Documents_and_Settings/All_Users/Start_Menu/Programs', 'DELETED_FILES_C:/Documents_and_Settings/<USER>/Desktop', 'DELETED_FILES_c:/windows/temp', 'OPENED_FILES_C:', 'OPENED_FILES_//./Global', 'OPENED_FILES_//./PIPE', 'OPENED_FILES_C:/WINDOWS', 'OPENED_FILES_C:/Documents_and_Settings/<USER>', 'OPENED_FILES_C:/Documents_and_Settings/<USER>/Start_Menu/Programs/Startup', 'OPENED_FILES_C:/WINDOWS/Registration', 'OPENED_FILES_C:/WINDOWS/system', 'OPENED_FILES_C:/WINDOWS/system32', 'OPENED_FILES_c:/windows/temp', 'READ_FILES_C:', 'READ_FILES_C:/Documents_and_Settings/<USER>/Application_Data/Microsoft/Internet_Explorer/Quick_Launch', 'READ_FILES_C:/WINDOWS/Registration', 'READ_FILES_C:/WINDOWS/system32', 'ANTIDEBUG_CheckRemoteDebuggerPresent', 'ANTIDEBUG_FindWindowExA', 'ANTIDEBUG_FindWindowExW', 'ANTIDEBUG_GetWindowThreadProcessId', 'ANTIDEBUG_%IsDebuggerPresent', 'ANTIDEBUG_OutputDebugStringA', 'ANTIDEBUG_Process32NextW', 'ANTIDEBUG_TerminateProcess', 'ANTIDEBUG_UnhandledExceptionFilter', 'IMPORTS_BIN_bind', 'IMPORTS_BIN_CallNextHookEx', 'IMPORTS_BIN_CharNextA', 'IMPORTS_BIN_CloseHandle', 'IMPORTS_BIN_CopyFile', 'IMPORTS_BIN_CreateDirectoryA', 'IMPORTS_BIN_CreateFile', 'IMPORTS_BIN_CreateMutex', 'IMPORTS_BIN_CreateProcessA', 'IMPORTS_BIN_CreateSymbolicLink', 'IMPORTS_BIN_DeleteCriticalSection', 'IMPORTS_BIN_DeleteFile', 'IMPORTS_BIN_DeleteObject', 'IMPORTS_BIN_DispatchMessageA', 'IMPORTS_BIN_EnterCriticalSection', 'IMPORTS_BIN_ExitProcess', 'IMPORTS_BIN_FileSize', 'IMPORTS_BIN_FindFirstFile', 'IMPORTS_BIN_FindNextFile', 'IMPORTS_BIN_FindWindow', 'IMPORTS_BIN_FreeLibrary', 'IMPORTS_BIN_GetACP', 'IMPORTS_BIN_GetClientRect', 'IMPORTS_BIN_GetCPInfo', 'IMPORTS_BIN_GetCurrentProcess', 'IMPORTS_BIN_GetCurrentThreadId', 'IMPORTS_BIN_GetDC', 'IMPORTS_BIN_GetDeviceCaps', 'IMPORTS_BIN_GetFileAttributes', 'IMPORTS_BIN_GetFileAttributesA', 'IMPORTS_BIN_GetFullPathName', 'IMPORTS_BIN_GetDlgItem', 'IMPORTS_BIN_GetFileInformation', 'IMPORTS_BIN_GetFileTime', 'IMPORTS_BIN_GetFileType', 'IMPORTS_BIN_GetLastError', 'IMPORTS_BIN_GetLongPathName', 'IMPORTS_BIN_GetShortPathName', 'IMPORTS_BIN_GetStdHandle', 'IMPORTS_BIN_GetSystemDirectoryA', 'IMPORTS_BIN_GetTempPathA', 'IMPORTS_BIN_GetTempFileName', 'IMPORTS_BIN_GetVersion', 'IMPORTS_BIN_GetWindowLongA', 'IMPORTS_BIN_GetWindowsDirectory', 'IMPORTS_BIN_GlobalAlloc', 'IMPORTS_BIN_GlobalLock', 'IMPORTS_BIN_GlobalFree', 'IMPORTS_BIN_GlobalUnlock', 'IMPORTS_BIN_HeapAlloc', 'IMPORTS_BIN_HeapFree', 'IMPORTS_BIN_inet_addr', 'IMPORTS_BIN_InitializeCriticalSection', 'IMPORTS_BIN_IsDebuggerPresent', 'IMPORTS_BIN_LeaveCriticalSection', 'IMPORTS_BIN_LoadLibrary', 'IMPORTS_BIN_lstrcpynA', 'IMPORTS_BIN_lstrlenA', 'IMPORTS_BIN_MapViewOfFile', 'IMPORTS_BIN_MoveFile', 'IMPORTS_BIN_MultiByteToWideChar', 'IMPORTS_BIN_OpenFile', 'IMPORTS_BIN_RegOpenKey', 'IMPORTS_BIN_RegQueryValueExA', 'IMPORTS_BIN_RegSetValueExA', 'IMPORTS_BIN_ReadFile', 'IMPORTS_BIN_RegCloseKey', 'IMPORTS_BIN_RtlUnwind', 'IMPORTS_BIN_SelectObject', 'IMPORTS_BIN_SetErrorMode', 'IMPORTS_BIN_SetFileAttributes', 'IMPORTS_BIN_SetFilePointer', 'IMPORTS_BIN_SetFileTime', 'IMPORTS_BIN_SetWindowLongA', 'IMPORTS_BIN_ShowWindow', 'IMPORTS_BIN_TlsGetValue', 'IMPORTS_BIN_WaitForSingleObject', 'IMPORTS_BIN_WideCharToMultiByte', 'IMPORTS_BIN_wsprintfA', 'HAS_OVERLAYS', 'NUM_IMPORTS', 'NUM_PACKERS', 'PACKER_Armadillo', 'PACKER_NullSoft', 'PACKER_UPX', 'RESOURCE_NUM', 'SERVICES_AudioSrv', 'SERVICES_Ias', 'SERVICES_NetDDEdsdm', 'SERVICES_Ntmssvc', 'SERVICES_RASMAN', 'SERVICES_Win32', 'SERVICES_WmiApSrv', 'SUSP_API_CopyFileA', 'SUSP_API_CopyFileW', 'SUSP_API_CreateFileA', 'SUSP_API_CreateFileW', 'SUSP_API_CreateProcessAsUserA', 'SUSP_API_CreateProcessW', 'SUSP_API_CreateProcessWithLogonW', 'SUSP_API_CreateServiceW', 'SUSP_API_CreateThread', 'SUSP_API_CryptEncrypt', 'SUSP_API_DeleteFileA', 'SUSP_API_DisconnectNamedPipe', 'SUSP_API_FindFirstFileA', 'SUSP_API_FindFirstFileExW', 'SUSP_API_FindNextFileA', 'SUSP_API_FindResourceA', 'SUSP_API_GetCommandLineW', 'SUSP_API_GetCommandLineA', 'SUSP_API_GetFileSize', 'SUSP_API_GetModuleFileNameA', 'SUSP_API_GetModuleHandleA', 'SUSP_API_GetProcAddress', 'SUSP_API_GetStartupInfoA', 'SUSP_API_GetStartupInfoW', 'SUSP_API_GetTempFileNameA', 'SUSP_API_GetTempPathW', 'SUSP_API_GetTickCount', 'SUSP_API_GetVersionExA', 'SUSP_API_HttpSendRequestExA', 'SUSP_API_HttpSendRequestExW', 'SUSP_API_InternetConnectA', 'SUSP_API_InternetOpenA', 'SUSP_API_InternetOpenUrlA', 'SUSP_API_InternetQueryOptionA', 'SUSP_API_LoadLibraryA', 'SUSP_API_LoadLibraryExA', 'SUSP_API_LoadLibraryW', 'SUSP_API_LockResource', 'SUSP_API_OpenFileMappingW', 'SUSP_API_OpenProcess', 'SUSP_API_RegCreateKeyExA', 'SUSP_API_RegCreateKeyW', 'SUSP_API_RegDeleteKeyA', 'SUSP_API_RegDeleteValueA', 'SUSP_API_RegEnumKeyA', 'SUSP_API_RegEnumKeyExA', 'SUSP_API_RegOpenKeyExA', 'SUSP_API_ShellExecuteA', 'SUSP_API_ShellExecuteExA', 'SUSP_API_Sleep', 'SUSP_API_SleepEx', 'SUSP_API_StartServiceA', 'SUSP_API_StartServiceCtrlDispatcherW', 'SUSP_API_StartServiceW', 'SUSP_API_VirtualAlloc', 'SUSP_API_VirtualFree', 'SUSP_API_VirtualProtect', 'SUSP_API_WriteFile', 'SUSP_API_WriteProcessMemory', 'SUSP_DLLS_COMCTL32.DLL', 'SUSP_DLLS_Msvcrt.dll', 'SUSP_DLLS_OLEAUT32.DLL', 'SUSP_DLLS_Shell32.dll', 'SUSP_DLLS_SHLWAPI.dll', 'SUSP_DLLS_ADVAPI32.dll', 'SUSP_DLLS_comdlg32.dll', 'SUSP_DLLS_crypt32.dll', 'SUSP_DLLS_GDI32.DLL', 'SUSP_DLLS_HAL.dll', 'SUSP_DLLS_KERNEL32.dll', 'SUSP_DLLS_MFC42.DLL', 'SUSP_DLLS_MSVFW32.dll', 'SUSP_DLLS_ntoskrnl.exe', 'SUSP_DLLS_OLE32.DLL', 'SUSP_DLLS_OPENGL32.DLL', 'SUSP_DLLS_SECUR32.dll', 'SUSP_DLLS_USER32.dll', 'SUSP_DLLS_version.dll', 'SUSP_DLLS_wininet.dll', 'SUSP_DLLS_WSOCK32.DLL', 'DNS_CH', 'DNS_CZ', 'DNS_IL', 'DNS_NL', 'DNS_SY', 'DNS_US', 'TCP_AE', 'TCP_CH', 'TCP_CN', 'TCP_DE', 'TCP_KR', 'TCP_MD', 'TCP_NL', 'TCP_US', 'UDP_CL', 'UDP_GB', 'UDP_MD', 'UDP_MT', 'UDP_US']] 
#
print ("NOS QUEDAMOS CON UN TOTAL DE FEATURES DE:")
print df.shape

####df=df1.iloc[0:20449,0:num] 
###df=df1 

#X=joblib.load("../tmp/dataset_limpiado_imputado_standarizado.joblib.pkl",  mmap_mode='r')
#X = preprocessing.scale(X)
#df=X

###EXTRAEMOS LAS CABECERAS Y LOS VALORES DEL DATASET
#num=200
num=1941
df=df.iloc[0:19457,0:num] 
atributos=list(df)
atributos2=atributos[0:num]
atributos2=atributos
#df3=df.values

###IMPUTAMS
#from sklearn.impute import SimpleImputer
#imp = SimpleImputer(strategy="most_frequent")
#X=imp.fit_transform(df)
#df = pd.DataFrame(X)
#Remove N/A:
#df2=df.dropna()
#Replace N/A with mean:
#df2 = df.fillna(df.mean())


#STANDARIZING
#from sklearn import preprocessing
#atributos=list(df)
#df2 = preprocessing.scale(df)
#df = pd.DataFrame(df2)

###...ASI COMO LAS CORRELACIONES ENTRE LOS CAMPOS
#Frame=pd.DataFrame([df], columns = atributos2)
#df=Frame
#print df[0:10]
correlations=df.corr()

#print correlations.headers
#print correlations.shape
#print correlations[0:10]
#correlations=correlations.fillna(correlations.mean())
#correlations=correlations.fillna(correlations.mean(axis=1))
#print correlations[0:10]
#print atributos2
#exit()

print argumentos[1]

if (argumentos[1]=="4" or argumentos[1]=="5"):
    print "Correlacion media de cada compo ordenada"
    print "========================================"
    with pd.option_context('display.max_rows', None, 'display.max_columns', None):
                X=correlations.abs().mean().sort_values()
                print (X)
                print (X.mean())

    if (argumentos[1]=="4"):
		exit()

if (argumentos[1]=="1" or argumentos[1]=="5"):
	df_attr = pd.Series( (v for v in atributos) )
	print("Top Absolute Correlations")
	print("=========================")
	print(get_top_abs_correlations(df, 400))

	#with pd.option_context('display.max_rows', None, 'display.max_columns', None):
		#print df_attr

	if (argumentos[1]=="1"):
		exit()

if (argumentos[1]=="2" or argumentos[1]=="5"):
###CREAMOS UNA FIGURA CON UNA SOLA GRAFICA
    fig = plt.figure(figsize=(36,36)) #TAMANYO FISICO DE LA IMAGEN GRANDE
    ax = fig.add_subplot(111)

###Y PINTAMOS EN ELLA LAS CORRELACIONES
    cax = ax.matshow(correlations, vmin=-1, vmax=1)
    fig.colorbar(cax)

#SIZE 6 para 90, size 5 para 240
    font = {'family': 'serif',
        'color':  'black',
        'weight': 'normal',
        'size': 4,
        }

    ticks = np.arange(0,num,1)
    ax.set_xticks(ticks)
    ax.set_yticks(ticks)
    ax.set_xticklabels(atributos2, fontdict=font)
    ax.set_yticklabels(atributos2, fontdict=font)

    plt.xticks(rotation=80)

    fig.savefig(output_file)

    plt.show()
