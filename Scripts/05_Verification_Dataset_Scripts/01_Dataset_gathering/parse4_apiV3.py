import json
from pprint import pprint
import ast
import os
import sys

insert_text=""

def sanitize (cad):
	return cad.replace(" ", "_").replace("-","_").replace("\\","/").replace("'","")

#Convierte el contenido de una lista en una ristra de secuencias INSERT y UPDATE	
def parse_list (campo, l, insert_text):
	First=True
	for i in l:
	   if type(i) == dict:
#            	print "\n\nTABLE: ", campo
		print_dict_rec(i)
	   else:
		if campo:
			if First:
	   			cad= ""+insert_text+" set "+sanitize(campo)+" = '"+sanitize(i)+"' where MD5='"+MD5+"'"
				First=False
			else:
	   			cad=cad+", "+sanitize(campo)+" = '"+sanitize(i)+"' where MD5='"+MD5+"'"
			
		print cad+";"			

#Convierte el contenido de un diccionario en una ristra de secuencias INSERT y UPDATE	
def print_dict_rec( indict ):
  global insert_text
  if indict is not None:
    for majorkey, subdict in indict.iteritems():
	 if type(subdict) == list:
	    #Si son listas y no estan vacias
	    if subdict and insert_text=="":
	    	print "\nINSERT INTO "+ sanitize(str(majorkey))+" (MD5) VALUES('"+MD5+"');"
	    	insert_text="UPDATE "+ sanitize(str(majorkey))
	    parse_list(majorkey,subdict, str(insert_text))
	    insert_text=""
         elif type(subdict) == dict:
	    print "\nINSERT INTO "+ sanitize(str(majorkey))+" (MD5) VALUES('"+MD5+"');"
	    insert_text="UPDATE "+ sanitize(str(majorkey))
            print_dict_rec(subdict)
	    insert_text=""
         else:
	    if subdict is not None:
		try:
			if (str(majorkey)=='update'):
				majorkey="updates"

            		print ""+insert_text+" set "+sanitize(str(majorkey))+" = '"+str(subdict) +"' where MD5='"+MD5+"';"
		
		except:
			print ""	

if len(sys.argv)!=2:
	print "\nError: Se necesita un argumento.\n"
	exit(98)
	
m=sys.argv[1]
mypath=os.path.join(m, "")

if not os.path.isdir(os.path.join(m, "")): 
	print "\nError: El parametro no es un directorio.\n"
	exit(99)

print "LOCK TABLES extra WRITE, FileSystem WRITE, HOOKING WRITE, HOSTS_FILE WRITE, mutex WRITE, TCP WRITE, UDP WRITE, DNS WRITE, HTTP WRITE, processes WRITE, RUNTIME_DLLS WRITE, exiftool WRITE, ALYac WRITE, AVG WRITE, AVware WRITE, Ad_Aware WRITE, AegisLab WRITE, Agnitum WRITE, AhnLab_V3 WRITE, Alibaba WRITE, Antiy_AVL WRITE, Arcabit WRITE, Avast WRITE, Avira WRITE, Baidu_International WRITE, BitDefender WRITE, Bkav WRITE, ByteHero WRITE, CAT_QuickHeal WRITE, CMC WRITE, CRC WRITE, ClamAV WRITE, Commtouch WRITE, Comodo WRITE, Cyren WRITE, DNS WRITE, DrWeb WRITE, ESET_NOD32 WRITE, Emsisoft WRITE, F_Prot WRITE, F_Secure WRITE, FileSystem WRITE, Fortinet WRITE, GData WRITE, GENERAL WRITE, HASHES WRITE, HOOKING WRITE, HOSTS_FILE WRITE, HTTP WRITE, Ikarus WRITE, Jiangmin WRITE, K7AntiVirus WRITE, K7GW WRITE, Kaspersky WRITE, Kingsoft WRITE, Malwarebytes WRITE, McAfee WRITE, McAfee_GW_Edition WRITE, MicroWorld_eScan WRITE, Microsoft WRITE, NANO_Antivirus WRITE, Norman WRITE, PACKERS2 WRITE, PE WRITE, PE_Resource_detail WRITE, PE_Resources WRITE, PE_Sections WRITE, Panda WRITE, Qihoo_360 WRITE, RUNTIME_DLLS WRITE, Rising WRITE, SIGCHECK WRITE, SUPERAntiSpyware WRITE, Sophos WRITE, Symantec WRITE, TCP WRITE, Tencent WRITE, TheHacker WRITE, TotalDefense WRITE, TrendMicro WRITE, TrendMicro_HouseCall WRITE, UDP WRITE, VBA32 WRITE, VIPRE WRITE, ViRobot WRITE, Zillya WRITE, Zoner WRITE, autostart WRITE, clamav WRITE, counter_signers_details WRITE, deepguard WRITE, eSafe WRITE, exiftool WRITE, exports WRITE, filetype WRITE, imports WRITE, imports2 WRITE, links WRITE, mutex WRITE, nProtect WRITE, netguids WRITE, opened_managers WRITE, overlay WRITE, packers WRITE, pescan WRITE, pescanner WRITE, processes WRITE, resources WRITE, samples WRITE, services WRITE, shellcmds WRITE, signers_details WRITE, submission_names WRITE, suspicious_sections WRITE, trendmicro_heuristics WRITE, verinfo WRITE, windows_searched WRITE, yara WRITE;"

for f in os.listdir(mypath):

 if f.endswith('.report') and os.path.isfile(os.path.join(mypath, f)):
  ########################################
  #Abrimos el fichero y lo hacemos legible
  with open(os.path.join(mypath, f)) as data_file:    
    file_content=data_file.read()
    aaa=ast.literal_eval(file_content)

  FILE_SUMMARY=aaa['FILE_SUMMARY']
  BEHAVIOUR_SUMMARY=aaa['BEHAVIOUR_SUMMARY']

  MD5=FILE_SUMMARY['data']['attributes']['md5']

  #######################
  #    BEHAVIOUR
  #######################
  ####print_dict_rec(aaa['additional_info']['behaviour-v1'])
  #La mayor parte del fichero es un diccionario llamado data
  
  #Dentro de behaviour-v1 estan los sudiccionarios:
  #- filesystem
  #- network
  #- runtime-dlls
  #- service


  if 'attributes' in FILE_SUMMARY['data']:

	#########
	#filesystem
	#########
	if 'file_copied' in BEHAVIOUR_SUMMARY['data']:
	   for destination, source in BEHAVIOUR_SUMMARY['data']['files_copied'].iteritems():
		print "INSERT INTO Copied_Files VALUES(0,'"+MD5+"','""','"+sanitize(str(fil['source']))+"','"+sanitize(str(fil['destination']))+"','"+str(fil['success'])+"');"
	
        if 'files_deleted' in BEHAVIOUR_SUMMARY['data']:
	   for path in BEHAVIOUR_SUMMARY['data']['files_deleted']:
		print "INSERT INTO FileSystem VALUES(0,'"+MD5+"','Deleted','"+sanitize(str(path))+"','True','');"
		
        if 'files_opened' in BEHAVIOUR_SUMMARY['data']:
	   for path in BEHAVIOUR_SUMMARY['data']['files_opened']:
		print "INSERT INTO FileSystem VALUES(0,'"+MD5+"','Opened','"+sanitize(str(path))+"','True','');"

        if 'files_written' in BEHAVIOUR_SUMMARY['data']:
	   for path in BEHAVIOUR_SUMMARY['data']['files_written']:
		print "INSERT INTO FileSystem VALUES(0,'"+MD5+"','Written','"+sanitize(str(path))+"','True','');"

        if 'files_dropped' in BEHAVIOUR_SUMMARY['data']:
	   for path in BEHAVIOUR_SUMMARY['data']['files_dropped']:
		print "INSERT INTO FileSystem VALUES(0,'"+MD5+"','Created','"+sanitize(str(path))+"','True','');"


	#########
	#network
	#########
	#print_dict_rec(aaa['additional_info']['behaviour-v1']['network'])
        if 'dns_lookups' in BEHAVIOUR_SUMMARY['data']:
            for lookup in BEHAVIOUR_SUMMARY['data']['dns_lookups']:
                if 'resolved_ips' in lookup:
                   for ip in lookup['resolved_ips']:
			print "INSERT INTO DNS VALUES(0,'"+MD5+"','"+lookup['hostname']+"','"+ip+"','','');"

        if 'ip_traffic' in BEHAVIOUR_SUMMARY['data']:
            for traffic in BEHAVIOUR_SUMMARY['data']['ip_traffic']:
                if 'transport_layer_protocol' in traffic:
                   if traffic['transport_layer_protocol']=="TCP":
                        if 'destination_port' in traffic:
			   print "INSERT INTO TCP VALUES(0,'"+MD5+"','"+str(traffic['destination_ip'])+"',"+str(traffic['destination_port'])+",'','');"
                        else:
			   print "INSERT INTO TCP VALUES(0,'"+MD5+"','"+str(traffic['destination_ip'])+"',"",'','');"
                   if traffic['transport_layer_protocol']=="UDP":
                        if 'destination_port' in traffic:
			   print "INSERT INTO UDP VALUES(0,'"+MD5+"','"+str(traffic['destination_ip'])+"',"+str(traffic['destination_port'])+",'','');"
                        else:
			   print "INSERT INTO UDP VALUES(0,'"+MD5+"','"+str(traffic['destination_ip'])+"',"",'','');"


	#########
	#runtime-dlls
	#########
	First=True
	cad=""
	if 'modules_loaded' in BEHAVIOUR_SUMMARY['data']:
	   for files in BEHAVIOUR_SUMMARY['data']['modules_loaded']:
	       cad="INSERT INTO RUNTIME_DLLS VALUES (0,'"+MD5+"','"+sanitize(str(files))+"','True')"
	       print cad+";"
               cad=""

	#########
	#service
	#########
	#print_dict_rec(aaa['additional_info']['behaviour-v1']['service'])
	if 'services_created' in BEHAVIOUR_SUMMARY['data']:
	   for service in BEHAVIOUR_SUMMARY['data']['services_created']:
		print "INSERT INTO services VALUES(0,'"+MD5+"','created','"+sanitize(service)+"','True');"
			
	if 'services_opened' in BEHAVIOUR_SUMMARY['data']:
	   for service in BEHAVIOUR_SUMMARY['data']['services_opened']:
		print "INSERT INTO services VALUES(0,'"+MD5+"','opened','"+sanitize(service)+"','True');"
	
        if 'services_started' in BEHAVIOUR_SUMMARY['data']:
	   for service in BEHAVIOUR_SUMMARY['data']['services_started']:
		print "INSERT INTO services VALUES(0,'"+MD5+"','started','"+sanitize(service)+"','True');"

  #######################
  #  EXPORTS
  #######################
  First=True
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'exports' in  FILE_SUMMARY['data']['attributes']['pe_info']:
         for ex in FILE_SUMMARY['data']['attributes']['pe_info']['exports']:
		cad= "\nINSERT INTO exports values(0,'"+MD5+"','"+sanitize(ex)+"')"
	        print cad+";"

  #######################
  #  IMPORTS
  #######################
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'import_list' in  FILE_SUMMARY['data']['attributes']['pe_info']:
        for impor in FILE_SUMMARY['data']['attributes']['pe_info']['import_list']:
            for function in impor['imported_functions']:
		cad="\nINSERT INTO imports2 values(0,'"+MD5+"', '"+sanitize(impor['library_name'])+"', '"+sanitize(function)+"' )"
	        print cad+";"
				
  #######################
  #   Filetype 
  #######################
  if 'magic' in FILE_SUMMARY['data']['attributes']:
  	print "\nINSERT INTO filetype values(0,'"+MD5+"', '"+FILE_SUMMARY['data']['attributes']['magic']+"');"

  #######################
  #    PE
  #######################
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'timestamp' in  FILE_SUMMARY['data']['attributes']['pe_info']:
	p1=str(FILE_SUMMARY['data']['attributes']['pe_info']['timestamp'])
     else:
	p1=""
  else:
     p1=""

  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'imphash' in  FILE_SUMMARY['data']['attributes']['pe_info']:
	p2=str(FILE_SUMMARY['data']['attributes']['pe_info']['imphash'])
     else:
	p2=""
  else:
     p2=""

  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'entry_point' in  FILE_SUMMARY['data']['attributes']['pe_info']:
	p3=str(FILE_SUMMARY['data']['attributes']['pe_info']['entry_point'])
     else:
	p3=""
  else:
     p3=""

  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'machine_type' in  FILE_SUMMARY['data']['attributes']['pe_info']:
	p4=str(FILE_SUMMARY['data']['attributes']['pe_info']['machine_type'])
     else:
	p4=""
  else:
     p4=""

  print "\nINSERT INTO PE values(0,'"+MD5+"', '"+p3+"', '"+p2+"','"+p4+"','"+p1+"');"

  #############
  ###OVERLAY###
  #############
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'overlay' in  FILE_SUMMARY['data']['attributes']['pe_info']:
        overlay=FILE_SUMMARY['data']['attributes']['pe_info']['overlay']
	print "\nINSERT INTO overlay values('"+MD5+"', "+str(overlay['entropy'])+", '"+sanitize(str(overlay['filetype']))+"','"+sanitize(str(overlay['md5']))+"',"+sanitize(str(overlay['offset']))+","+sanitize(str(overlay['size']))+");"

  #############
  ##RESOURCE###
  #############
  ####faltan los resource-langs y los resource-types
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'resource_details' in  FILE_SUMMARY['data']['attributes']['pe_info']:
	for resource in FILE_SUMMARY['data']['attributes']['pe_info']['resource_details']:
		cad= "\nINSERT INTO PE_Resource_detail values(0,'"+MD5+"', '"+resource['filetype']+"', '"+resource['lang']+"','"+resource['sha256']+"', '"+resource['type']+"')"
	        print cad+";"
	

  #############
  ##SECTIONS###
  #############
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'sections' in  FILE_SUMMARY['data']['attributes']['pe_info']:
        for section in FILE_SUMMARY['data']['attributes']['pe_info']['sections']:
		cad= "\nINSERT INTO PE_Sections values(0,'"+MD5+"','"+str(section['name'])+"','"+str(section['virtual_address'])+"','"+str(section['virtual_size'])+"','"+str(section['raw_size'])+"','"+str(section['entropy'])+"','"+str(section['md5'])+"')"
	        print cad+";"
			
	
  #############
  ###GENERAL###
  #############

  ###333 means Malware for sencond dataset
  print "\nINSERT INTO GENERAL values (0,'"+MD5+"','-','-','-','"+str(FILE_SUMMARY['data']['attributes']['first_submission_date'])+"','"+str(FILE_SUMMARY['data']['attributes']['last_submission_date'])+"','"+str(FILE_SUMMARY['data']['attributes']['last_analysis_stats']['harmless'])+"','"+str(FILE_SUMMARY['data']['attributes']['last_analysis_stats']['malicious'])+"','0','"+str(FILE_SUMMARY['data']['attributes']['size'])+"','0','"+str(FILE_SUMMARY['data']['attributes']['times_submitted'])+"','','333');"


  #############
  ###HASHES###
  #############
  if 'authentihash' in FILE_SUMMARY['data']['attributes']:
	a1=str(FILE_SUMMARY['data']['attributes']['authentihash'])
  else:
	a1=""

  a2=""
  a3=""
  a4=""
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'sha1' in FILE_SUMMARY['data']['attributes']['pe_info']:
	a2=str(FILE_SUMMARY['data']['attributes']['pe_info']['sha1'])

     if 'sha256' in FILE_SUMMARY['data']['attributes']['pe_info']:
	a3=str(FILE_SUMMARY['data']['attributes']['pe_info']['sha256'])

     if 'ssdeep' in FILE_SUMMARY['data']['attributes']['pe_info']:
	a4=str(FILE_SUMMARY['data']['attributes']['pe_info']['ssdeep'])

  print "\nINSERT INTO HASHES values (0,'"+MD5+"','"+a1+"','"+a2+"','"+a3+"','"+a4+"');"

  #############
  ###SUBMISSION NAMES###
  #############
  First=True
  Fail=False
  cad=""
  for i in FILE_SUMMARY['data']['attributes']['names']:
		cad= "\nINSERT INTO submission_names values(0,'"+MD5+"','"+sanitize(str(i))+"')"
  	        print cad+";"

  #############
  ###PACKERS###
  #############
  if 'pe_info' in FILE_SUMMARY['data']['attributes']:
     if 'packers' in FILE_SUMMARY['data']['attributes']['pe_info']:
	for peid, packer in FILE_SUMMARY['data']['attributes']['pe_info']['packers'].iteritems():
	    print "\nINSERT INTO PACKERS2 values (0,'"+MD5+"','peid','"+sanitize(str(packer))+"');" 


  data_file.close()


print "UNLOCK TABLES extra WRITE, FileSystem WRITE, HOOKING WRITE, HOSTS_FILE WRITE, mutex WRITE, TCP WRITE, UDP WRITE, DNS WRITE, HTTP WRITE, processes WRITE, RUNTIME_DLLS WRITE, exiftool WRITE, ALYac WRITE, AVG WRITE, AVware WRITE, Ad_Aware WRITE, AegisLab WRITE, Agnitum WRITE, AhnLab_V3 WRITE, Alibaba WRITE, Antiy_AVL WRITE, Arcabit WRITE, Avast WRITE, Avira WRITE, Baidu_International WRITE, BitDefender WRITE, Bkav WRITE, ByteHero WRITE, CAT_QuickHeal WRITE, CMC WRITE, CRC WRITE, ClamAV WRITE, Commtouch WRITE, Comodo WRITE, Copied_Files WRITE, Cyren WRITE, DNS WRITE, DrWeb WRITE, ESET_NOD32 WRITE, Emsisoft WRITE, F_Prot WRITE, F_Secure WRITE, FileSystem WRITE, Fortinet WRITE, GData WRITE, GENERAL WRITE, HASHES WRITE, HOOKING WRITE, HOSTS_FILE WRITE, HTTP WRITE, Ikarus WRITE, Jiangmin WRITE, K7AntiVirus WRITE, K7GW WRITE, Kaspersky WRITE, Kingsoft WRITE, Malwarebytes WRITE, McAfee WRITE, McAfee_GW_Edition WRITE, MicroWorld_eScan WRITE, Microsoft WRITE, NANO_Antivirus WRITE, Norman WRITE, PACKERS2 WRITE, PE WRITE, PE_Resource_detail WRITE, PE_Resources WRITE, PE_Sections WRITE, Panda WRITE, Qihoo_360 WRITE, RUNTIME_DLLS WRITE, Rising WRITE, SIGCHECK WRITE, SUPERAntiSpyware WRITE, Sophos WRITE, Symantec WRITE, TCP WRITE, Tencent WRITE, TheHacker WRITE, TotalDefense WRITE, TrendMicro WRITE, TrendMicro_HouseCall WRITE, UDP WRITE, VBA32 WRITE, VIPRE WRITE, ViRobot WRITE, Zillya WRITE, Zoner WRITE, autostart WRITE, clamav WRITE, counter_signers_details WRITE, deepguard WRITE, eSafe WRITE, exiftool WRITE, exports WRITE, filetype WRITE, imports WRITE, imports2 WRITE, links WRITE, mutex WRITE, nProtect WRITE, netguids WRITE, opened_managers WRITE, overlay WRITE, packers WRITE, pescan WRITE, pescanner WRITE, processes WRITE, resources WRITE, samples WRITE, services WRITE, shellcmds WRITE, signers_details WRITE, submission_names WRITE, suspicious_sections WRITE, trendmicro_heuristics WRITE, verinfo WRITE, windows_searched WRITE, yara WRITE;"
