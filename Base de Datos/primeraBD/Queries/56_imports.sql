use APTs;

-- Para poder hacer un concat mas largo de lo habitual:
SET group_concat_max_len=150000;

create table imports4 select md5, group_concat(function) function 
       from imports2 group by md5;

--Con las que se lanzó la siguiente query, que crea la tabla imports_binary que contendrán una línea con 192 0’s y 1’s que se corresponderán con la utilización de estos imports:

create table suspicious_imports4_binary select MD5, concat ('', CASE WHEN function LIKE '%accept%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%AdjustTokenPrivileges%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%AttachThreadIOnput%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%AttributesSetFileApisToANSI%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%BeginPaint%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%bind%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ByHandle%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ByHandleEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CallNextHookEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CallWindowProcA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CertOpenSystemStore%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CharNextA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CheckRemoteDebuggerPresent%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CloseHandle%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CloseHandle.%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%connect%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CopyFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CopyFileEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CopyFileTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateDirectoryA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateFileA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateFileMapping%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateFileTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateHardLink%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateMutex%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateProcess%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateProcessA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateRemoteThread%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateSymbolic%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateSymbolicLink%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateThread%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%CreateWindowExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DefWindowProcA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DeleteCriticalSection%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DeleteFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DeleteFileA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DeleteFileTransacted.%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DeleteObject%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DestroyWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%DispatchMessageA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%EnableExecuteProtectionSupport%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%EnableWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%EndPaint%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%EnterCriticalSection%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ExitProcess%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FileSize%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindClose%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFileA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFileEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFileName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFileNameW%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstFileTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstStream%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindFirstStreamW%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindNextFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindNextFileNameW%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindNextStreamW%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindResource%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FindWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%FreeLibrary%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetACP%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetBinaryType%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetClientRect%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCommandLineA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCompressed%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCompressedFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCPInfo%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCurrentProcess%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCurrentProcessId%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetCurrentThreadId%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetDC%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetDeviceCaps%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetDlgItem%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileAttributes%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileAttributesA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileAttributesEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileBandwidth%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileInformation%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileSize%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileSizeEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileTime%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFileType%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFinalPathName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetFullPathName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetLastError%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetLongPathName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetModuleFileNameA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetModuleHandleA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetProcAddress%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetShortPathName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetStartupInfoA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetStdHandle%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetSysColor%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetSystemDirectory%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetSystemDirectoryA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetSystemMetrics%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetTempFileName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetTempPath.%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetTempPathA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetThreadContext%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetTickCount%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetVersion%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetVersionExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetWindowLongA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetWindowRect%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GetWindowsDirectory%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GlobalAlloc%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GlobalFree%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GlobalLock%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%GlobalUnlock%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%HeapAlloc%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%HeapFree%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%inet_addr%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%InitializeCriticalSection%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%InternetOpen%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%InvalidateRect%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%IsDebuggerPresent%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%IsWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%IsWindowVisible%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LdrLoadDll%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LeaveCriticalSection%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LinkTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LoadCursorA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LoadLibrary%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LoadLibraryA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%LoadResource%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%lstrcpynA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%lstrlenA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MapViewOfFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MessageBoxA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MoveFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MoveFileEx%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MoveFileTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MoveFileWithProgress.%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%MultiByteToWideChar%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%NetScheduleJobAdd%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%OpenFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%OpenFileById%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%PeekMessageA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%PostQuitMessage%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RaiseException%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ReadFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegCloseKey%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegCreateKey%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegCreateKeyExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegOpenKey%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegOpenKeyExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegQueryValueExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegSetValue%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RegSetValueExA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ReOpenFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ReplaceFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%Reservation%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%RtlUnwind%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SearchPath.%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SelectObject%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SendMessageA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetErrorMode%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileApisToOEM%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileAttributes%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileAttributesTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileBandwidthReservation%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileInformationByHandle%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFilePointer%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileShortName%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileTime%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetFileValidData%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetForegroundWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetTimer%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetWindowLongA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SetWindowPos%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ShellExecuteA%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%ShowWindow%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%SizeTransacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%Sleep%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%TerminateProcess%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%TlsGetValue%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%TlsSetValue%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%Transacted%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%TransactedW%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%UnhandledExceptionFilter%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%UnMapViewOfFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%VirtualAlloc%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%VirtualFree%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%VirtualProtect%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%WaitForSingleObject%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%WideCharToMultiByte%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%WriteFile%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%WriteProcessMemory%' THEN '1' ELSE '0' END, CASE WHEN function LIKE '%wsprintfA%' THEN '1' ELSE '0' END ) binario from imports4;

UPDATE newCSV SET IMPORTS_BINARY=(SELECT BINARIO FROM new_suspicious_imports4_binary I where I.MD5=newCSV.MD5);

UPDATE newCSV SET NUM_IMPORTS=(SELECT COUNT(*) FROM IMPORTS2 WHERE IMPORTS2.MD5=newCSV.MD5);
